# Milestone v1.2: Claude CLI Agent Integration

**Status:** SHIPPED 2026-02-11
**Phases:** 16-19
**Total Plans:** 7

## Overview

Replace all Anthropic SDK API calls with Claude CLI agent subprocesses so AI features run on the user's Anthropic subscription instead of requiring a separate API key with per-token charges. Add SSE streaming for resume/cover letter generation and on-demand AI scoring.

## Phases

### Phase 16: CLI Wrapper Foundation

**Goal**: System can invoke Claude CLI as a subprocess with typed structured output, graceful error handling, and no Anthropic SDK runtime dependency
**Depends on**: Nothing (foundation phase)
**Plans**: 2 plans

Plans:

- [x] 16-01-PLAN.md -- Build claude_cli package (exceptions, parser, client) with comprehensive tests
- [x] 16-02-PLAN.md -- Replace SDK in resume_ai, update webapp call sites, remove SDK dependency, update test infrastructure

**Details:**
- Requirements: CLI-01, CLI-02, CLI-03, CFG-01
- Success Criteria: Calling CLI wrapper returns validated Pydantic model; handles all error paths (timeout, bad JSON, auth, missing); SDK removed from runtime
- Key artifacts: claude_cli/ package (client.py, parser.py, exceptions.py), 7-class exception hierarchy, resilient JSON parser for structured_output/result field regression, cold-start retry
- PEP 695 type parameters required by ruff UP047 on Python 3.14 target
- Separate except clauses needed to avoid ruff auto-fix breaking tuple-style multi-exception catches
- CLIError wrapped in RuntimeError at resume_ai boundary for webapp backward compatibility
- CLI model alias "sonnet" used instead of full model ID

### Phase 17: AI Scoring

**Goal**: User can trigger a deep AI-powered job-fit analysis from the dashboard and see semantic score, reasoning, strengths, and gaps alongside the existing rule-based score
**Depends on**: Phase 16 (CLI wrapper)
**Plans**: 2 plans

Plans:

- [x] 17-01-PLAN.md -- AI scorer module (AIScoreResult model + score_job_ai function), database migration v7, unit tests
- [x] 17-02-PLAN.md -- Dashboard POST endpoint, htmx partial, job detail page UI with button and persisted score display

**Details:**
- Requirements: SCR-01, SCR-02, SCR-03
- Success Criteria: "AI Rescore" button triggers analysis; results persist in DB and survive reload; CLI failures show clear error without affecting rule-based score
- Key artifacts: ai_scorer.py (single module at project root), AIScoreResult Pydantic model, DB schema v7 (ai_score, ai_score_breakdown, ai_scored_at columns), POST /jobs/{key}/ai-rescore endpoint, ai_score_result.html partial
- Amber-600 button color to differentiate from other sidebar buttons
- Inline persisted score in job_detail.html (no include partial) to avoid extra request on page load
- mock_claude_cli fixture promoted to root conftest for project-wide availability

### Phase 18: Resume Tailoring via CLI + SSE

**Goal**: Resume tailoring runs through Claude CLI instead of the Anthropic SDK and shows real-time SSE progress events during generation
**Depends on**: Phase 16 (CLI wrapper)
**Plans**: 1 plan

Plans:

- [x] 18-01-PLAN.md -- SSE-backed resume tailoring pipeline (background task, SSE endpoints, htmx template, tests)

**Details:**
- Requirements: RES-01, RES-02, RES-03, RES-04
- Success Criteria: "Tailor Resume" streams 4-stage SSE progress; anti-fabrication validation runs; PDF rendering unchanged; version tracking works; background cleanup on disconnect
- Key artifacts: _resume_sessions/_resume_tasks dicts, _run_resume_tailor background task, resume_tailor_status.html partial, 6 integration tests
- Pre-render resume_diff.html in background task and embed in done event HTML
- Patch source modules (resume_ai.*) in tests since _run_resume_tailor uses lazy imports

### Phase 19: Cover Letter via CLI + SSE & Cleanup

**Goal**: Cover letter generation runs through Claude CLI with SSE streaming, and all documentation reflects the new CLI prerequisite
**Depends on**: Phase 16 (CLI wrapper), Phase 18 (SSE pattern established)
**Plans**: 2 plans

Plans:

- [x] 19-01-PLAN.md -- SSE cover letter pipeline (background task, SSE endpoints, htmx templates, tests)
- [x] 19-02-PLAN.md -- Documentation update (CLAUDE.md, architecture.md, INTEGRATIONS.md, PROJECT.md) and SDK cleanup verification

**Details:**
- Requirements: COV-01, COV-02, COV-03, CFG-02
- Success Criteria: "Generate Cover Letter" streams 3-stage SSE progress; PDF rendering unchanged; all docs reference Claude CLI; no production code imports anthropic SDK
- Key artifacts: _cover_sessions/_cover_tasks dicts, cover_letter_status.html + cover_letter_result.html partials, 6 integration tests, updated CLAUDE.md/architecture.md/INTEGRATIONS.md/PROJECT.md
- 3-stage pipeline (no validation stage unlike 4-stage resume tailor)
- Emerald-500 spinner and collapsible text preview in done event
- Historical/contextual SDK references in PROJECT.md preserved (requirements/decisions describe transition)
- config.yaml "anthropic" tech keyword preserved (legitimate technology name for job matching)

---

## Milestone Summary

**Key Decisions:**

- Replace Anthropic SDK with Claude CLI subprocess for all AI features (runs on subscription, no API key needed)
- asyncio.create_subprocess_exec for CLI calls (not subprocess.run in to_thread) -- enables streaming
- AI scores stored as new columns on jobs table (not separate table)
- SSE streaming for resume/cover letter follows apply_engine pattern (Queue + background task + EventSourceResponse)
- Resilient JSON parser needed for CLI --json-schema regression (handle both structured_output and result fields)
- PEP 695 type parameters required by ruff UP047 on Python 3.14 target
- CLIError wrapped in RuntimeError at resume_ai boundary for webapp backward compatibility
- CLI model alias "sonnet" instead of full model ID (CLI resolves aliases)
- Controller pattern for mock_claude_cli fixture (set_response/set_error methods)
- Single-module ai_scorer.py at project root (not a package)
- Pre-render resume_diff.html in background task, embed in done event HTML
- 3-stage cover letter pipeline (no validation stage unlike 4-stage resume tailor)

**Issues Resolved:**

- Claude CLI --json-schema regression (structured_output vs result field) handled by resilient parser
- PEP 695 type parameters needed for ruff UP047 compliance on Python 3.14
- Ruff auto-fix destructively converts tuple-style except to Python 2 comma syntax
- Hardcoded schema version assertions in test_db.py broke after migration v7

**Issues Deferred:**

- Batch AI rescore ("Score All" with queue and progress bar) -- deferred to v2+
- Token-by-token streaming during structured output -- JSON Schema output arrives complete
- AI score explanation with highlighted job description sections -- deferred to v2+
- Generation cost tracking from CLI JSON response usage metadata -- deferred to v2+

**Technical Debt Incurred:**

- SSE endpoint testing relies on background task testing pattern (direct Queue testing), not actual SSE stream parsing
- Lazy imports in background tasks require patching source modules (not webapp.app) in tests

---

_For current project status, see .planning/ROADMAP.md_
