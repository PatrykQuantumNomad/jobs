---
phase: 07-ai-resume-cover-letter
plan: 03
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - resume_ai/renderer.py
  - resume_ai/diff.py
  - webapp/templates/resume/resume_template.html
  - webapp/templates/resume/cover_letter_template.html
autonomous: true

must_haves:
  truths:
    - "Tailored resume renders as a professional 2-page PDF with ATS-friendly formatting"
    - "Cover letter renders as a clean 1-page PDF"
    - "Diff view shows side-by-side comparison of original vs tailored resume text"
    - "Resume PDF uses standard section headers and readable font"
  artifacts:
    - path: "resume_ai/renderer.py"
      provides: "HTML-to-PDF rendering for resume and cover letter"
      exports: ["render_resume_pdf", "render_cover_letter_pdf"]
      min_lines: 40
    - path: "resume_ai/diff.py"
      provides: "HTML diff generation for resume comparison"
      exports: ["generate_resume_diff_html"]
    - path: "webapp/templates/resume/resume_template.html"
      provides: "Jinja2 HTML template for resume PDF rendering"
      contains: "PROFESSIONAL SUMMARY"
    - path: "webapp/templates/resume/cover_letter_template.html"
      provides: "Jinja2 HTML template for cover letter PDF rendering"
      contains: "{{ greeting }}"
  key_links:
    - from: "resume_ai/renderer.py"
      to: "webapp/templates/resume/resume_template.html"
      via: "Jinja2 FileSystemLoader"
      pattern: "FileSystemLoader"
    - from: "resume_ai/renderer.py"
      to: "weasyprint"
      via: "HTML(string=...).write_pdf()"
      pattern: "HTML.*write_pdf"
    - from: "resume_ai/diff.py"
      to: "difflib"
      via: "HtmlDiff.make_table()"
      pattern: "HtmlDiff.*make_table"
---

<objective>
Build the PDF rendering pipeline (WeasyPrint + Jinja2 templates) and the diff generation module (difflib) for comparing original vs tailored resumes.

Purpose: Converts the structured LLM output into downloadable PDFs and provides the visual diff that lets users verify no content was fabricated. The diff view is a key anti-fabrication guardrail (Success Criteria #2).

Output: `resume_ai/renderer.py`, `resume_ai/diff.py`, and two HTML templates in `webapp/templates/resume/`.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-ai-resume-cover-letter/07-RESEARCH.md
@.planning/phases/07-ai-resume-cover-letter/07-01-SUMMARY.md
@resume_ai/models.py
@webapp/templates/base.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Resume and cover letter HTML templates</name>
  <files>
    webapp/templates/resume/resume_template.html
    webapp/templates/resume/cover_letter_template.html
  </files>
  <action>
Create the `webapp/templates/resume/` directory and two standalone HTML templates (these are NOT Jinja2 {% extends "base.html" %} -- they are standalone documents rendered to PDF by WeasyPrint).

1. Create `webapp/templates/resume/resume_template.html`:
   - Full HTML document with `<!DOCTYPE html>`, `<html>`, `<head>`, `<body>`.
   - Inline `<style>` block with:
     - `@page { size: letter; margin: 0.6in 0.7in; }` for proper page sizing
     - Font: `font-family: 'Calibri', 'Carlito', 'Helvetica Neue', Arial, sans-serif;` (Calibri preferred per CLAUDE.md, Carlito as fallback)
     - Body: `font-size: 10pt; line-height: 1.4; color: #333;`
     - Section headers (h2): `font-size: 13pt; font-weight: bold; text-transform: uppercase; border-bottom: 1px solid #555; padding-bottom: 2px; margin-top: 14pt; margin-bottom: 6pt; color: #222;`
     - Name header (h1): `font-size: 18pt; font-weight: bold; margin: 0; text-align: center; color: #111;`
     - Contact info: `text-align: center; font-size: 9pt; color: #555; margin-top: 4pt;`
     - Skills: `.skill-category { font-weight: bold; }` and inline list
     - Work experience: `.job-header { display: flex; justify-content: space-between; margin-top: 8pt; }`, `.job-title { font-weight: bold; }`, `.job-period { font-style: italic; color: #555; }`
     - Bullet points: `ul { margin: 2pt 0; padding-left: 16pt; } li { margin-bottom: 2pt; }`
     - Avoid page breaks inside experience blocks: `.experience-entry { page-break-inside: avoid; }`
   - Template variables (Jinja2):
     - `{{ name }}` -- candidate full name
     - `{{ contact_info }}` -- email | phone | location line
     - `{{ summary }}` -- professional summary paragraph
     - `{% for section in skills %}` with `{{ section.category }}` and `{{ section.skills | join(', ') }}`
     - `{% for exp in experience %}` with company, title, period, achievements (bullet list)
     - `{% for project in projects %}` as bullet items
     - `{{ education }}`

2. Create `webapp/templates/resume/cover_letter_template.html`:
   - Full standalone HTML document (not extending base.html).
   - Inline `<style>` block:
     - `@page { size: letter; margin: 1in; }`
     - Same font family as resume template
     - Body: `font-size: 11pt; line-height: 1.6; color: #333;`
     - Date and address block styling
     - Paragraph spacing: `p { margin-bottom: 12pt; }`
   - Template variables:
     - `{{ date }}` -- current date formatted
     - `{{ candidate_name }}`, `{{ candidate_email }}`, `{{ candidate_phone }}`
     - `{{ greeting }}`
     - `{{ opening_paragraph }}`
     - `{% for para in body_paragraphs %}{{ para }}{% endfor %}`
     - `{{ closing_paragraph }}`
     - `{{ sign_off }}`
     - `{{ candidate_name }}` (signature)
  </action>
  <verify>
Run: `python -c "from jinja2 import Environment, FileSystemLoader; env = Environment(loader=FileSystemLoader('webapp/templates/resume')); t = env.get_template('resume_template.html'); print('Resume template OK')"` -- template loadable.
Run: `python -c "from jinja2 import Environment, FileSystemLoader; env = Environment(loader=FileSystemLoader('webapp/templates/resume')); t = env.get_template('cover_letter_template.html'); print('Cover letter template OK')"` -- template loadable.
  </verify>
  <done>
Both HTML templates exist as standalone documents with inline CSS, ATS-friendly section headers, proper @page rules, and all required Jinja2 variables.
  </done>
</task>

<task type="auto">
  <name>Task 2: PDF renderer and diff generator</name>
  <files>
    resume_ai/renderer.py
    resume_ai/diff.py
  </files>
  <action>
1. Create `resume_ai/renderer.py`:
   - Import Jinja2 Environment, FileSystemLoader; WeasyPrint HTML; Path.
   - Define `TEMPLATE_DIR = Path(__file__).parent.parent / "webapp" / "templates" / "resume"` for template loading.
   - Create a module-level `_env` lazy-init pattern (or just create in function) using `Environment(loader=FileSystemLoader(str(TEMPLATE_DIR)), autoescape=True)`.
   - `render_resume_pdf(tailored: TailoredResume, candidate_name: str, contact_info: str, output_path: Path) -> Path`:
     - Load `resume_template.html` from the Jinja2 environment
     - Render with: name=candidate_name, contact_info=contact_info, summary=tailored.professional_summary, skills=tailored.technical_skills, experience=tailored.work_experience, projects=tailored.key_projects, education=tailored.education
     - Call `HTML(string=html_content, base_url=str(TEMPLATE_DIR)).write_pdf(str(output_path))`
     - Ensure output_path parent directory exists (output_path.parent.mkdir(parents=True, exist_ok=True))
     - Return output_path
   - `render_cover_letter_pdf(letter: CoverLetter, candidate_name: str, candidate_email: str, candidate_phone: str, output_path: Path) -> Path`:
     - Load `cover_letter_template.html`
     - Render with: date=date.today().strftime("%B %d, %Y"), candidate_name, candidate_email, candidate_phone, greeting=letter.greeting, opening_paragraph=letter.opening_paragraph, body_paragraphs=letter.body_paragraphs, closing_paragraph=letter.closing_paragraph, sign_off=letter.sign_off
     - Write PDF to output_path
     - Return output_path
   - Import TailoredResume and CoverLetter from resume_ai.models (use TYPE_CHECKING guard if needed to avoid circular imports).

2. Create `resume_ai/diff.py`:
   - Import `difflib` from stdlib.
   - `generate_resume_diff_html(original_text: str, tailored_text: str) -> str`:
     - Split both texts into lines
     - Create `difflib.HtmlDiff(tabsize=2, wrapcolumn=80)`
     - Call `differ.make_table(fromlines=original_lines, tolines=tailored_lines, fromdesc="Original Resume", todesc="Tailored Resume", context=True, numlines=3)`
     - Return the HTML table string
   - Add basic CSS wrapper function `wrap_diff_html(diff_table: str) -> str` that wraps the raw diff table in a `<div class="resume-diff">` with minimal styling to make it readable in the dashboard:
     - `.resume-diff table { width: 100%; border-collapse: collapse; font-size: 12px; font-family: monospace; }`
     - `.resume-diff td { padding: 2px 6px; }`
     - Green background for additions, red for deletions (standard difflib classes: `.diff_add`, `.diff_chg`, `.diff_sub`)
   - Follow project conventions.
  </action>
  <verify>
Run: `python -c "from resume_ai.renderer import render_resume_pdf, render_cover_letter_pdf; print('Renderer OK')"` -- importable.
Run: `python -c "from resume_ai.diff import generate_resume_diff_html, wrap_diff_html; html = generate_resume_diff_html('line 1\nline 2', 'line 1\nline 3'); assert 'Original Resume' in html; print('Diff OK')"` -- diff produces HTML with labels.
Run: `python -c "
from resume_ai.renderer import render_resume_pdf
from resume_ai.models import TailoredResume, SkillSection, WorkExperience
from pathlib import Path
import tempfile
t = TailoredResume(
    professional_summary='Experienced engineer.',
    technical_skills=[SkillSection(category='Cloud', skills=['K8s', 'GKE'])],
    work_experience=[WorkExperience(company='Acme', title='CTO', period='2020-2024', achievements=['Led team of 10'])],
    key_projects=['Kubert AI Platform'],
    education='BS Computer Science',
    tailoring_notes='Test'
)
out = Path(tempfile.mktemp(suffix='.pdf'))
result = render_resume_pdf(t, 'Test User', 'test@example.com | 555-1234', out)
assert result.exists()
assert result.stat().st_size > 0
print(f'PDF generated: {result.stat().st_size} bytes')
out.unlink()
"` -- PDF generates successfully (requires weasyprint system dependency installed).
  </verify>
  <done>
render_resume_pdf() and render_cover_letter_pdf() produce PDF files from structured data. generate_resume_diff_html() produces side-by-side HTML diff. Templates use ATS-friendly formatting with proper @page rules and professional styling.
  </done>
</task>

</tasks>

<verification>
1. Both HTML templates exist in `webapp/templates/resume/`
2. `render_resume_pdf()` produces a valid PDF file from TailoredResume data
3. `render_cover_letter_pdf()` produces a valid PDF file from CoverLetter data
4. `generate_resume_diff_html()` produces HTML showing differences between two texts
5. PDF uses Calibri/Carlito font, letter size pages, proper margins
</verification>

<success_criteria>
- Resume template has ATS-friendly section headers (PROFESSIONAL SUMMARY, TECHNICAL SKILLS, etc.)
- Cover letter template produces clean single-page layout
- PDFs render without WeasyPrint errors (assuming system dependency installed)
- Diff HTML highlights additions and deletions with color coding
- Both renderer functions accept structured model data and produce Path to written PDF
</success_criteria>

<output>
After completion, create `.planning/phases/07-ai-resume-cover-letter/07-03-SUMMARY.md`
</output>
