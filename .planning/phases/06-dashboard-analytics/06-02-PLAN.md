---
phase: 06-dashboard-analytics
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - webapp/app.py
  - webapp/templates/kanban.html
  - webapp/templates/partials/kanban_card.html
autonomous: true

must_haves:
  truths:
    - "User can view a kanban board with jobs as cards in columns organized by status"
    - "User can drag a job card from one status column to another to change its status"
    - "Dragging a card persists the status change to the database"
    - "Column counts update immediately when a card is moved"
    - "Stats refresh automatically when a card is moved between columns (no page refresh)"
    - "Kanban board only shows user-managed statuses (not discovered or scored)"
    - "Cards snap back to original column if the server request fails"
  artifacts:
    - path: "webapp/app.py"
      provides: "GET /kanban endpoint, modified POST /jobs/{key}/status with HX-Trigger header"
      contains: "kanban"
    - path: "webapp/templates/kanban.html"
      provides: "Kanban board layout with SortableJS initialization"
      contains: "Sortable"
    - path: "webapp/templates/partials/kanban_card.html"
      provides: "Individual kanban card partial with job title, company, score"
      contains: "kanban-card"
  key_links:
    - from: "webapp/templates/kanban.html"
      to: "SortableJS CDN"
      via: "{% block scripts %} with script tag"
      pattern: "sortablejs.*Sortable\\.min"
    - from: "SortableJS onEnd callback"
      to: "POST /jobs/{key}/status"
      via: "htmx.ajax() with status value from evt.to.dataset.status"
      pattern: "htmx\\.ajax.*POST.*status"
    - from: "POST /jobs/{key}/status response"
      to: "statsChanged HX-Trigger"
      via: "HX-Trigger response header triggers stats refresh"
      pattern: "HX-Trigger.*statsChanged"
    - from: "kanban stats panel"
      to: "GET /api/stats-cards"
      via: "hx-trigger='statsChanged from:body' listener"
      pattern: "statsChanged from:body"
---

<objective>
Build the kanban board view with drag-and-drop status management using SortableJS.

Purpose: Users need a visual pipeline view to manage their active job applications. The kanban board shows jobs as cards in status columns, and drag-and-drop lets users quickly move jobs through their pipeline. This is more intuitive than the table view for active pipeline management (saved through offer/rejected).

Output: `/kanban` page with SortableJS drag-and-drop between 9 status columns, real-time stats updates via HX-Trigger, and a reusable kanban card partial.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-dashboard-analytics/06-RESEARCH.md
@.planning/phases/06-dashboard-analytics/06-01-SUMMARY.md
@webapp/db.py
@webapp/app.py
@webapp/templates/base.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Kanban endpoint, HX-Trigger on status update, and stats-cards endpoint</name>
  <files>webapp/app.py, webapp/templates/partials/kanban_card.html</files>
  <action>
1. In `webapp/app.py`, add a `GET /kanban` endpoint (HTMLResponse):
   - Define `KANBAN_STATUSES` list: `["saved", "applied", "phone_screen", "technical", "final_interview", "offer", "rejected", "withdrawn", "ghosted"]` -- excludes "discovered" and "scored" per research recommendation (those have too many jobs and are managed in table view).
   - For each status, call `db.get_jobs(status=status, sort_by="score", sort_dir="desc")` to populate columns.
   - Also get basic stats via `db.get_stats()` for the stats cards.
   - Pass `kanban_statuses`, `columns` (dict of status -> job list), `stats`, and `statuses` (full list for reference) to `kanban.html`.

2. Modify the existing `POST /jobs/{dedup_key:path}/status` endpoint:
   - After updating the status, add `HX-Trigger: statsChanged` response header. This triggers stats refresh on any listening component (analytics stats cards, kanban stats panel).
   - The response body stays the same (status badge HTML).
   - Use: `response = HTMLResponse(f'<span class="status-badge status-{status}">{label}</span>'); response.headers["HX-Trigger"] = "statsChanged"; return response`

3. Add a `GET /api/stats-cards` endpoint (HTMLResponse):
   - Calls `db.get_stats()` and optionally `db.get_enhanced_stats()` if available.
   - Returns the `partials/stats_cards.html` partial rendered with current stats.
   - This endpoint is hit when `statsChanged` event fires (via hx-trigger="statsChanged from:body").

4. Create `webapp/templates/partials/kanban_card.html`:
   - A single card div with class `kanban-card bg-white rounded-lg shadow-sm border p-3 cursor-grab active:cursor-grabbing`
   - `data-key="{{ job.dedup_key }}"` for identifying the job in drag callbacks
   - Content:
     - Job title (font-medium text-sm, truncated with `truncate` class)
     - Company name (text-xs text-gray-500)
     - Score badge if score exists (use existing score-N CSS classes)
     - Platform badge (text-xs, muted)
   - Keep card compact -- no salary, no description, no location (those are on the detail page)
   - Make the card a clickable link to `/jobs/{{ job.dedup_key }}` -- use an `<a>` tag wrapping the content, but SortableJS needs `draggable` on the card div. Use a nested structure: outer div is the drag handle, inner `<a>` handles click. Or: detect drag vs click in JS (SortableJS `filter` option) -- simpler approach: just use the card as both draggable and clickable, and SortableJS's `onEnd` fires only for drags (not clicks). The `<a>` tag inside works naturally for clicks.
  </action>
  <verify>
Run: `cd /Users/patrykattc/work/jobs && python -c "from webapp.app import app; from fastapi.testclient import TestClient; c = TestClient(app); r = c.get('/kanban'); print('kanban status:', r.status_code); assert r.status_code == 200; r2 = c.get('/api/stats-cards'); print('stats-cards status:', r2.status_code); assert r2.status_code == 200"`
  </verify>
  <done>
`/kanban` returns 200 with kanban board HTML. `/api/stats-cards` returns 200 with stats cards partial. `POST /jobs/{key}/status` includes `HX-Trigger: statsChanged` header. kanban_card.html partial exists with job title, company, score, and data-key attribute.
  </done>
</task>

<task type="auto">
  <name>Task 2: Kanban board template with SortableJS drag-and-drop</name>
  <files>webapp/templates/kanban.html</files>
  <action>
Create `webapp/templates/kanban.html` extending base.html:

**Page structure:**
- Title: "Kanban -- Job Tracker"
- Top section: Stats cards panel with `id="kanban-stats"`, `hx-get="/api/stats-cards"`, `hx-trigger="statsChanged from:body"`, `hx-swap="innerHTML"`. Include `partials/stats_cards.html`.
- Main section: horizontal scrollable container with kanban columns

**Kanban layout:**
- Outer container: `flex gap-4 overflow-x-auto pb-4` for horizontal scroll when columns overflow
- Each column: `min-w-[280px] flex-shrink-0` with:
  - Header: status name (replace _ with space, title case) + count in parentheses with class `col-count`
  - Muted/dimmed styling for terminal statuses (rejected, withdrawn, ghosted) -- use `opacity-60` on the column header
  - Column body: `kanban-list space-y-2 min-h-[200px] bg-gray-50 rounded-lg p-2` with `data-status="{{ status }}"` and `id="col-{{ status }}"`
  - Cards: loop over `columns[status]` and include `partials/kanban_card.html` for each job

**SortableJS initialization (in {% block scripts %}):**
1. Load SortableJS 1.15.6 via CDN: `https://cdn.jsdelivr.net/npm/sortablejs@1.15.6/Sortable.min.js`
2. Place initialization script AFTER CDN tag (synchronous, no async/defer)
3. For each `.kanban-list` element, create `new Sortable(list, {...})` with:
   - `group: 'kanban'` -- allows dragging between all columns
   - `animation: 150` -- smooth drag animation
   - `ghostClass: 'opacity-30'` -- ghost effect on drag
   - `dragClass: 'shadow-lg'` -- lifted shadow on dragged card
   - `forceFallback: true` -- consistent cross-browser behavior per research
   - `onEnd: async function(evt)` callback:
     a. Extract `dedupKey` from `evt.item.dataset.key`
     b. Extract `newStatus` from `evt.to.dataset.status`
     c. Extract `oldStatus` from `evt.from.dataset.status`
     d. If `newStatus === oldStatus`, return (same column, no change)
     e. Optimistically update column counts: `updateColumnCount(oldStatus, -1)` and `updateColumnCount(newStatus, 1)`
     f. Try: `await htmx.ajax('POST', '/jobs/' + encodeURIComponent(dedupKey) + '/status', { values: { status: newStatus } })`
     g. Catch: rollback DOM position (`evt.from.insertBefore(evt.item, evt.from.children[evt.oldIndex])`), rollback counts, log error to console

4. `updateColumnCount(status, delta)` function:
   - Find `.kanban-column[data-status="${status}"] .col-count`
   - Parse current text as int, add delta, set new text

**Empty state:** If all columns are empty (no user-managed jobs), show a centered message: "No jobs in pipeline yet. Score and save jobs from the main dashboard to see them here."

**Link back:** Include a small link "View all jobs in table" pointing to "/" above the kanban board.
  </action>
  <verify>
Run: `cd /Users/patrykattc/work/jobs && python -c "from webapp.app import app; from fastapi.testclient import TestClient; c = TestClient(app); r = c.get('/kanban'); assert r.status_code == 200; assert 'Sortable' in r.text or 'sortablejs' in r.text.lower(); assert 'kanban-list' in r.text; print('kanban page OK')" `
Open `http://127.0.0.1:8000/kanban` in browser:
  1. Verify 9 status columns are visible (saved through ghosted)
  2. Verify cards appear in correct columns
  3. Drag a card between columns -- status should update
  4. Column counts should update on drag
  5. No JS errors in browser console
  6. Stats cards should refresh after drag (statsChanged event)
  </verify>
  <done>
Kanban board renders with 9 status columns, SortableJS enables drag-and-drop between columns. Dragging a card fires htmx.ajax() to persist the status change, column counts update optimistically, and stats cards refresh via HX-Trigger. Failed drags roll back the card to its original column.
  </done>
</task>

</tasks>

<verification>
1. `python -c "from webapp.app import app; from fastapi.testclient import TestClient; c = TestClient(app); r = c.get('/kanban'); assert r.status_code == 200; assert 'sortablejs' in r.text.lower() or 'Sortable' in r.text"` -- kanban page loads with SortableJS
2. `python -c "from webapp.app import app; from fastapi.testclient import TestClient; c = TestClient(app); r = c.post('/jobs/test::job/status', data={'status': 'applied'}); print(r.headers.get('HX-Trigger', 'MISSING')); assert r.headers.get('HX-Trigger') == 'statsChanged'"` -- HX-Trigger present on status updates
3. Open `http://127.0.0.1:8000/kanban` -- drag a card between columns, verify status persists and stats update
4. Navigate from kanban to analytics and back -- both pages load correctly
5. Nav bar shows Analytics and Kanban links on all pages
</verification>

<success_criteria>
- /kanban page renders with 9 status columns (no discovered/scored)
- Jobs appear as cards in their correct status columns
- SortableJS enables drag-and-drop between columns
- Dragging a card persists status change via POST /jobs/{key}/status
- Column counts update immediately on drag
- Stats cards refresh via HX-Trigger statsChanged event
- Failed drags roll card back to original column
- Cards link to job detail page when clicked (not dragged)
- No JS errors in browser console
</success_criteria>

<output>
After completion, create `.planning/phases/06-dashboard-analytics/06-02-SUMMARY.md`
</output>
