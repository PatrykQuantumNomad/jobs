---
phase: 06-dashboard-analytics
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - webapp/db.py
  - webapp/app.py
  - webapp/templates/base.html
  - webapp/templates/analytics.html
  - webapp/templates/partials/stats_cards.html
autonomous: true

must_haves:
  truths:
    - "Dashboard shows jobs discovered per day for the last 30 days as a bar chart"
    - "Dashboard shows per-platform effectiveness (total, high-quality, avg score, actioned count)"
    - "Dashboard shows application response rate as a percentage"
    - "Dashboard shows average time-in-stage for each status using activity_log data"
    - "Dashboard shows status funnel with count and percentage at each stage"
    - "Analytics page loads chart data inline (no extra API round-trip on page load)"
    - "JSON API endpoint exists for refreshing chart data without page reload"
  artifacts:
    - path: "webapp/db.py"
      provides: "get_enhanced_stats() returning jobs_per_day, by_platform, response_rate, time_in_stage, status_funnel"
      contains: "get_enhanced_stats"
    - path: "webapp/app.py"
      provides: "GET /analytics page, GET /api/analytics JSON endpoint"
      contains: "analytics"
    - path: "webapp/templates/analytics.html"
      provides: "Charts page with Canvas elements and Chart.js initialization"
      contains: "Chart"
    - path: "webapp/templates/base.html"
      provides: "{% block scripts %} for page-specific JS, nav link to /analytics"
      contains: "block scripts"
    - path: "webapp/templates/partials/stats_cards.html"
      provides: "htmx-swappable stats summary cards (total, applied, response rate, high-quality)"
      contains: "stats"
  key_links:
    - from: "webapp/templates/analytics.html"
      to: "Chart.js CDN"
      via: "{% block scripts %} with script tag"
      pattern: "chart\\.js.*chart\\.umd"
    - from: "webapp/app.py /analytics endpoint"
      to: "db.get_enhanced_stats()"
      via: "Function call, passes result as analytics_json to template"
      pattern: "get_enhanced_stats"
    - from: "webapp/app.py /api/analytics"
      to: "db.get_enhanced_stats()"
      via: "Returns JSONResponse for chart refresh"
      pattern: "JSONResponse"
    - from: "analytics.html inline script"
      to: "analyticsData embedded JSON"
      via: "{{ analytics_json | safe }} in script block"
      pattern: "analytics_json.*safe"
---

<objective>
Build the analytics engine and stats dashboard page with Chart.js visualizations.

Purpose: Users need to visualize their job search progress -- how many jobs discovered over time, which platforms produce the best results, what their application response rate is, and how long jobs sit in each pipeline stage. This plan creates the SQLite analytics queries, the FastAPI endpoints, and the Chart.js-powered analytics page.

Output: `get_enhanced_stats()` function in db.py, `/analytics` page with 5 charts, `/api/analytics` JSON endpoint, `stats_cards.html` partial, and `{% block scripts %}` support in base.html.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-dashboard-analytics/06-RESEARCH.md
@webapp/db.py
@webapp/app.py
@webapp/templates/base.html
@webapp/templates/dashboard.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Analytics queries and base.html scripts block</name>
  <files>webapp/db.py, webapp/templates/base.html, webapp/templates/partials/stats_cards.html</files>
  <action>
1. In `webapp/db.py`, add a `get_enhanced_stats()` function that returns a dict with these keys, using SQLite window functions and aggregation (all queries verified in 06-RESEARCH.md):

   - `total`: total job count
   - `jobs_per_day`: list of `{"date": "YYYY-MM-DD", "count": N}` for last 30 days using `strftime('%Y-%m-%d', created_at)` GROUP BY
   - `by_platform`: list of `{"name": str, "total": int, "high_quality": int, "avg_score": float, "actioned": int}` -- high_quality = score >= 4, actioned = status in ('applied','phone_screen','technical','final_interview','offer')
   - `response_rate`: `{"total_applied": int, "responded": int, "rate_pct": float}` -- applied = status NOT IN ('discovered','scored','saved'), responded = status IN ('phone_screen','technical','final_interview','offer'). Guard against division by zero.
   - `time_in_stage`: list of `{"stage": str, "avg_days": float, "transitions": int}` using LAG() window function over activity_log WHERE event_type='status_change', PARTITION BY dedup_key ORDER BY created_at. Filter out NULL and <= 0 duration_days.
   - `status_funnel`: list of `{"status": str, "count": int, "pct": float}` ordered by pipeline progression (discovered=1 through ghosted=11). Guard against division by zero when total is 0.

   Use a single `with get_conn() as conn:` block for all queries (reuse connection). Return all results as plain dicts/lists (JSON-serializable).

2. In `webapp/templates/base.html`, add `{% block scripts %}{% endblock %}` just before `</body>` to allow child templates to load page-specific JavaScript (Chart.js, SortableJS). This follows the research recommendation to avoid loading heavy JS globally.

3. In `webapp/templates/base.html`, add nav links for "Analytics" (`/analytics`) and "Kanban" (`/kanban`) in the nav bar's flex container, styled like the existing "Run History" link.

4. Create `webapp/templates/partials/stats_cards.html` -- a reusable partial with 4 summary cards in a responsive grid:
   - Total Jobs (stats.total)
   - Applied (stats.by_status.applied or 0)
   - Response Rate (enhanced_stats.response_rate.rate_pct with "%" suffix, or "N/A" if no applications)
   - High Quality / Score 4+ (sum of by_platform high_quality values, or stats.by_score.get(4,0) + stats.by_score.get(5,0))

   Use Tailwind classes matching existing dashboard card styling (bg-white rounded-lg shadow-sm p-4 border).
  </action>
  <verify>
Run: `python -c "from webapp import db; s = db.get_enhanced_stats(); print(list(s.keys())); print('jobs_per_day:', len(s['jobs_per_day'])); print('by_platform:', s['by_platform']); print('response_rate:', s['response_rate']); print('time_in_stage:', s['time_in_stage']); print('status_funnel:', len(s['status_funnel']))"` -- should print all keys with reasonable data (may be empty lists if DB has no data, but no errors).
Verify base.html has `{% block scripts %}` before `</body>`.
Verify base.html nav has Analytics and Kanban links.
  </verify>
  <done>
`get_enhanced_stats()` returns a dict with 6 keys (total, jobs_per_day, by_platform, response_rate, time_in_stage, status_funnel). base.html has `{% block scripts %}` block. Nav has Analytics and Kanban links. stats_cards.html partial exists with 4 summary cards.
  </done>
</task>

<task type="auto">
  <name>Task 2: Analytics page with Chart.js and JSON API endpoint</name>
  <files>webapp/app.py, webapp/templates/analytics.html</files>
  <action>
1. In `webapp/app.py`, add two endpoints:

   a. `GET /analytics` (HTMLResponse) -- calls `db.get_enhanced_stats()`, passes result to `analytics.html` template. Also passes `json.dumps(stats)` as `analytics_json` for inline chart initialization (Pattern 2 from research -- eliminates initial API round-trip). Import `json` (already imported).

   b. `GET /api/analytics` (JSONResponse) -- calls `db.get_enhanced_stats()`, returns as JSONResponse. Import `JSONResponse` from `fastapi.responses`. This endpoint is used by the kanban page to refresh stats after drag-and-drop without full page reload.

   Remove the existing `/stats` endpoint (it was a placeholder from Phase 5 that just renders dashboard.html with empty jobs). The new `/analytics` replaces it with proper analytics.

2. Create `webapp/templates/analytics.html` extending base.html:

   **Layout:**
   - Page title: "Analytics -- Job Tracker"
   - Top section: include `partials/stats_cards.html` in a div with `id="analytics-stats"` and `hx-get="/api/stats-cards" hx-trigger="statsChanged from:body" hx-swap="innerHTML"` (listens for statsChanged events from kanban drags)
   - Charts section: 2-column grid on large screens, 1-column on mobile

   **Charts (5 total):**
   a. **Jobs Discovered Per Day** (bar chart, `id="chart-jobs-per-day"`, canvas 400x200):
      - labels = jobs_per_day dates, data = jobs_per_day counts
      - Blue bars (#3b82f6), y-axis beginAtZero

   b. **Platform Effectiveness** (doughnut chart, `id="chart-platform"`, canvas 300x300):
      - labels = platform names, data = platform totals
      - Use a color palette: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6']

   c. **Status Funnel** (horizontal bar chart, `id="chart-funnel"`, canvas 400x300):
      - labels = status names (replace _ with space, title case), data = counts
      - Use status colors matching the CSS classes in base.html

   d. **Time in Stage** (horizontal bar chart, `id="chart-time-stage"`, canvas 400x250):
      - labels = stage names, data = avg_days
      - Orange bars (#f59e0b)
      - Show "No data yet" text if time_in_stage array is empty

   e. **Response Rate** (doughnut chart, `id="chart-response"`, canvas 200x200):
      - Two segments: "Responded" and "No Response"
      - Green (#10b981) for responded, gray (#e5e7eb) for no response
      - Center text plugin showing the rate_pct percentage (or use a large number display above the chart instead of center text -- simpler)

   **Scripts (in {% block scripts %}):**
   - Load Chart.js 4.5.1 via CDN: `https://cdn.jsdelivr.net/npm/chart.js@4.5.1/dist/chart.umd.min.js`
   - Parse inline data: `const analyticsData = {{ analytics_json | safe }};`
   - Initialize all 5 charts using `createOrUpdateChart()` helper function that checks `Chart.getChart(canvas)` for existing instances and calls `.destroy()` before creating new ones (destroy guard pattern from research)
   - Handle empty data gracefully: if an array is empty, show "No data yet" text on the canvas or skip chart creation
   - Place Chart.js CDN `<script>` tag BEFORE the initialization script (synchronous loading, no async/defer)

   **Refresh button:** Add a "Refresh" button that calls `fetch('/api/analytics')` and re-initializes charts with new data. Use `chart.data = newData; chart.update('none')` for in-place updates where possible, or destroy+recreate for simplicity.
  </action>
  <verify>
Run: `cd /Users/patrykattc/work/jobs && python -c "from webapp.app import app; from fastapi.testclient import TestClient; c = TestClient(app); r = c.get('/analytics'); print('analytics status:', r.status_code); assert r.status_code == 200; assert 'chart.js' in r.text.lower(); r2 = c.get('/api/analytics'); print('api status:', r2.status_code); print('api keys:', list(r2.json().keys())); assert r2.status_code == 200"`
  </verify>
  <done>
`/analytics` returns 200 with HTML containing Chart.js CDN, canvas elements, and inline analytics data. `/api/analytics` returns 200 with JSON containing all analytics keys. Charts render correctly with real or empty data. Refresh button updates charts without page reload.
  </done>
</task>

</tasks>

<verification>
1. `python -c "from webapp import db; s = db.get_enhanced_stats(); assert all(k in s for k in ['total','jobs_per_day','by_platform','response_rate','time_in_stage','status_funnel'])"` -- all analytics keys present
2. `python -c "from webapp.app import app; from fastapi.testclient import TestClient; c = TestClient(app); assert c.get('/analytics').status_code == 200; assert c.get('/api/analytics').status_code == 200"` -- both endpoints work
3. Open `http://127.0.0.1:8000/analytics` in browser -- page loads with charts (data may be empty but no JS errors in console)
4. Nav bar shows Analytics and Kanban links on all pages
5. base.html has `{% block scripts %}` before `</body>`
</verification>

<success_criteria>
- get_enhanced_stats() returns 6 analytics data sections with no errors
- /analytics page renders with 5 Chart.js charts (bar, doughnut, horizontal bar)
- /api/analytics returns JSON with all analytics data
- Chart data is embedded inline on page load (no initial API call needed)
- Refresh button updates charts via /api/analytics
- Stats cards partial is reusable (will be used by kanban page in Plan 02)
- No JS errors in browser console on analytics page
</success_criteria>

<output>
After completion, create `.planning/phases/06-dashboard-analytics/06-01-SUMMARY.md`
</output>
