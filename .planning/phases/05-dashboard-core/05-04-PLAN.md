---
phase: 05-dashboard-core
plan: 04
type: execute
wave: 3
depends_on: ["05-02", "05-03"]
files_modified:
  - webapp/app.py
  - webapp/templates/dashboard.html
  - webapp/templates/partials/job_rows.html
autonomous: true

must_haves:
  truths:
    - "User can select multiple jobs with checkboxes on the dashboard"
    - "A bulk action bar appears showing count of selected jobs and a status dropdown"
    - "Clicking 'Apply' on bulk bar updates all selected jobs to the chosen status"
    - "Select-all checkbox toggles all visible job checkboxes"
    - "User can click an Export CSV button and receive a .csv file download"
    - "User can click an Export JSON button and receive a .json file download"
    - "Export respects active filters and search query"
    - "Status dropdown on dashboard table rows shows all 9 user-facing statuses"
  artifacts:
    - path: "webapp/app.py"
      provides: "POST /bulk/status, GET /export/csv, GET /export/json endpoints"
      contains: "def bulk_status_update"
    - path: "webapp/templates/dashboard.html"
      provides: "Bulk action bar, checkboxes, export buttons, select-all JS"
      contains: "bulk-bar"
    - path: "webapp/templates/partials/job_rows.html"
      provides: "Checkbox column in each row"
      contains: "job_keys"
  key_links:
    - from: "webapp/templates/dashboard.html"
      to: "/bulk/status"
      via: "hx-post on bulk bar button"
      pattern: "hx-post=\"/bulk/status\""
    - from: "webapp/templates/dashboard.html"
      to: "/export/csv"
      via: "link with filter params"
      pattern: "/export/csv"
    - from: "webapp/app.py"
      to: "webapp/db.py"
      via: "get_jobs with search param for export"
      pattern: "db\\.get_jobs.*search="
---

<objective>
Add bulk status actions (select multiple jobs, change status at once), CSV/JSON export with filter awareness, and checkbox/select-all UI to the dashboard.

Purpose: DASH-03 (bulk status actions) and DASH-04 (export filtered results). Completes the remaining dashboard core features.
Output: Bulk action bar with checkboxes, export buttons downloading filtered data, all wired with htmx.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-dashboard-core/05-RESEARCH.md
@.planning/phases/05-dashboard-core/05-01-SUMMARY.md
@.planning/phases/05-dashboard-core/05-02-SUMMARY.md
@.planning/phases/05-dashboard-core/05-03-SUMMARY.md

@webapp/app.py
@webapp/db.py
@webapp/templates/dashboard.html
@webapp/templates/partials/job_rows.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add bulk status update and export endpoints to app.py</name>
  <files>webapp/app.py</files>
  <action>
In webapp/app.py:

1. Add necessary imports at the top (if not already present):
   ```python
   import csv
   import io
   from datetime import date
   from fastapi.responses import StreamingResponse
   ```
   Note: `Form` may need to be imported from fastapi if not already (check existing imports). Also need `from typing import Annotated` and `from fastapi import Form` -- check what is already imported.

2. Add POST /bulk/status endpoint:
   ```python
   @app.post("/bulk/status", response_class=HTMLResponse)
   async def bulk_status_update(
       request: Request,
       job_keys: Annotated[list[str], Form()] = [],
       bulk_status: str = Form(""),
       q: str = Form(""),
       score: int | None = Form(None),
       platform: str | None = Form(None),
       status: str | None = Form(None),
       sort: str = Form("score"),
       dir: str = Form("desc"),
   ):
       if bulk_status and job_keys:
           for key in job_keys:
               db.update_job_status(key, bulk_status)
       # Re-fetch with current filters and return updated table body
       jobs = db.get_jobs(
           search=q if q else None,
           score_min=score,
           platform=platform,
           status=status,
           sort_by=sort,
           sort_dir=dir,
       )
       return templates.TemplateResponse(
           "partials/job_rows.html",
           {"request": request, "jobs": jobs, "statuses": STATUSES},
       )
   ```
   Note: The activity logging for each status change is already handled inside db.update_job_status() (wired in Plan 01). No extra logging needed here.

   IMPORTANT: For `job_keys` to work as a list from multiple checkboxes, use `Annotated[list[str], Form()]` with a default of `[]`. FastAPI/Starlette requires this pattern for repeated form fields.

3. Add GET /export/csv endpoint:
   ```python
   @app.get("/export/csv")
   async def export_csv(
       q: str = Query(""),
       score: int | None = Query(None),
       platform: str | None = Query(None),
       status: str | None = Query(None),
       sort: str = Query("score"),
       dir: str = Query("desc"),
   ):
       jobs = db.get_jobs(
           search=q if q else None,
           score_min=score,
           platform=platform,
           status=status,
           sort_by=sort,
           sort_dir=dir,
       )
       output = io.StringIO()
       fields = ["title", "company", "location", "salary_display", "platform",
                  "status", "score", "url", "posted_date", "created_at"]
       writer = csv.DictWriter(output, fieldnames=fields, extrasaction="ignore")
       writer.writeheader()
       for job in jobs:
           writer.writerow(job)
       output.seek(0)
       filename = f"jobs_export_{date.today().isoformat()}.csv"
       return StreamingResponse(
           iter([output.getvalue()]),
           media_type="text/csv",
           headers={"Content-Disposition": f'attachment; filename="{filename}"'},
       )
   ```

4. Add GET /export/json endpoint:
   ```python
   @app.get("/export/json")
   async def export_json(
       q: str = Query(""),
       score: int | None = Query(None),
       platform: str | None = Query(None),
       status: str | None = Query(None),
       sort: str = Query("score"),
       dir: str = Query("desc"),
   ):
       jobs = db.get_jobs(
           search=q if q else None,
           score_min=score,
           platform=platform,
           status=status,
           sort_by=sort,
           sort_dir=dir,
       )
       # Filter to relevant fields for export
       fields = ["title", "company", "location", "salary_display", "platform",
                  "status", "score", "url", "apply_url", "posted_date",
                  "created_at", "notes"]
       export_data = [{k: job.get(k) for k in fields} for job in jobs]
       output = json.dumps(export_data, indent=2)
       filename = f"jobs_export_{date.today().isoformat()}.json"
       return StreamingResponse(
           iter([output]),
           media_type="application/json",
           headers={"Content-Disposition": f'attachment; filename="{filename}"'},
       )
   ```
  </action>
  <verify>
```bash
cd /Users/patrykattc/work/jobs && python -c "
from webapp.app import app
from fastapi.testclient import TestClient

client = TestClient(app)

# Check bulk endpoint exists
assert any(r.path == '/bulk/status' for r in app.routes), 'Missing /bulk/status route'

# Check export endpoints exist
assert any(r.path == '/export/csv' for r in app.routes), 'Missing /export/csv route'
assert any(r.path == '/export/json' for r in app.routes), 'Missing /export/json route'

# Test CSV export returns valid response
resp = client.get('/export/csv')
assert resp.status_code == 200, f'CSV export returned {resp.status_code}'
assert 'text/csv' in resp.headers.get('content-type', ''), 'CSV wrong content type'
assert 'attachment' in resp.headers.get('content-disposition', ''), 'CSV missing attachment header'

# Test JSON export
resp = client.get('/export/json')
assert resp.status_code == 200, f'JSON export returned {resp.status_code}'
assert 'application/json' in resp.headers.get('content-type', ''), 'JSON wrong content type'

print('ALL ENDPOINT TESTS PASSED')
"
```
  </verify>
  <done>POST /bulk/status updates multiple jobs at once with activity logging. GET /export/csv and GET /export/json return filtered downloads with date-stamped filenames. All endpoints respect search and filter parameters.</done>
</task>

<task type="auto">
  <name>Task 2: Add checkboxes, bulk action bar, and export buttons to dashboard templates</name>
  <files>webapp/templates/dashboard.html, webapp/templates/partials/job_rows.html</files>
  <action>
In webapp/templates/partials/job_rows.html:

1. Add a checkbox column as the FIRST `<td>` in each row. The checkbox must NOT trigger the row's onclick navigation:
   ```html
   <td class="px-4 py-3" onclick="event.stopPropagation()">
       <input type="checkbox" name="job_keys" value="{{ job.dedup_key }}"
              onchange="updateBulkBar()" class="rounded border-gray-300">
   </td>
   ```
   Also add the checkbox td to the empty state row, adjusting colspan from 7 to 8.

In webapp/templates/dashboard.html:

2. Add a checkbox column header as the FIRST `<th>` in the table header:
   ```html
   <th class="px-4 py-3 w-10">
       <input type="checkbox" id="select-all" class="rounded border-gray-300"
              onchange="toggleSelectAll(this)">
   </th>
   ```

3. Wrap the entire job table (the `<div class="bg-white rounded-lg shadow-sm border overflow-hidden">` containing the table) in a `<form id="bulk-form">`. The form does NOT have an action or method -- it is used only as an htmx include source.

4. Add the bulk action bar BETWEEN the filter section and the job table. It should be hidden by default and shown when checkboxes are selected:
   ```html
   <div id="bulk-bar" class="hidden bg-indigo-50 border border-indigo-200 rounded-lg p-3 mb-4 flex items-center gap-4">
       <span id="selected-count" class="text-sm font-medium text-indigo-800">0 selected</span>
       <select name="bulk_status" class="border rounded px-3 py-1.5 text-sm">
           <option value="">Change status to...</option>
           {% for s in statuses %}
           <option value="{{ s }}">{{ s | replace('_', ' ') | title }}</option>
           {% endfor %}
       </select>
       <button type="button"
               hx-post="/bulk/status"
               hx-include="#bulk-form, [name='q'], [name='score'], [name='platform'], [name='status'], [name='sort'], [name='dir']"
               hx-target="#job-table-body"
               hx-swap="innerHTML"
               class="bg-indigo-600 text-white px-4 py-1.5 rounded text-sm font-medium hover:bg-indigo-700">
           Apply
       </button>
       <button type="button" onclick="clearSelection()" class="text-sm text-gray-500 hover:text-gray-700">
           Clear
       </button>
   </div>
   ```

5. Add export buttons. Place them in a row between the bulk bar and the table (or alongside the "X jobs displayed" count at the bottom). Best location: at the bottom of the page, next to the job count:
   ```html
   <div class="mt-4 flex items-center justify-between">
       <div class="text-sm text-gray-400">{{ jobs | length }} jobs displayed</div>
       <div class="flex gap-2">
           <a id="export-csv-link"
              href="/export/csv?q={{ filters.q or '' | urlencode }}&score={{ filters.score or '' }}&platform={{ filters.platform or '' }}&status={{ filters.status or '' }}&sort={{ filters.sort or 'score' }}&dir={{ filters.dir or 'desc' }}"
              class="text-sm px-3 py-1.5 rounded border text-gray-600 hover:bg-gray-50">
               Export CSV
           </a>
           <a id="export-json-link"
              href="/export/json?q={{ filters.q or '' | urlencode }}&score={{ filters.score or '' }}&platform={{ filters.platform or '' }}&status={{ filters.status or '' }}&sort={{ filters.sort or 'score' }}&dir={{ filters.dir or 'desc' }}"
              class="text-sm px-3 py-1.5 rounded border text-gray-600 hover:bg-gray-50">
               Export JSON
           </a>
       </div>
   </div>
   ```
   Remove the old standalone `<div class="mt-4 text-sm text-gray-400">{{ jobs | length }} jobs displayed</div>`.

6. Add the select-all and bulk bar JavaScript at the bottom of the content block (after the table, before `{% endblock %}`):
   ```html
   <script>
   function toggleSelectAll(el) {
       document.querySelectorAll('input[name="job_keys"]').forEach(cb => {
           cb.checked = el.checked;
       });
       updateBulkBar();
   }

   function updateBulkBar() {
       const count = document.querySelectorAll('input[name="job_keys"]:checked').length;
       document.getElementById('selected-count').textContent = count + ' selected';
       document.getElementById('bulk-bar').classList.toggle('hidden', count === 0);
   }

   function clearSelection() {
       document.querySelectorAll('input[name="job_keys"]').forEach(cb => cb.checked = false);
       document.getElementById('select-all').checked = false;
       updateBulkBar();
   }

   // Re-attach after htmx swaps (checkboxes are replaced)
   document.body.addEventListener('htmx:afterSwap', function(e) {
       if (e.detail.target.id === 'job-table-body') {
           document.getElementById('select-all').checked = false;
           updateBulkBar();
       }
   });
   </script>
   ```
  </action>
  <verify>
```bash
cd /Users/patrykattc/work/jobs && python -c "
from pathlib import Path

# Check partial has checkbox
partial = Path('webapp/templates/partials/job_rows.html').read_text()
assert 'name=\"job_keys\"' in partial, 'Missing checkbox in partial'
assert 'stopPropagation' in partial, 'Checkbox should stop click propagation'

# Check dashboard
dash = Path('webapp/templates/dashboard.html').read_text()
assert 'bulk-bar' in dash, 'Missing bulk action bar'
assert 'select-all' in dash, 'Missing select-all checkbox'
assert 'bulk_status' in dash, 'Missing bulk status dropdown'
assert 'hx-post=\"/bulk/status\"' in dash, 'Missing bulk submit'
assert 'export/csv' in dash, 'Missing CSV export link'
assert 'export/json' in dash, 'Missing JSON export link'
assert 'toggleSelectAll' in dash, 'Missing select-all JS function'
assert 'updateBulkBar' in dash, 'Missing updateBulkBar JS function'
assert 'htmx:afterSwap' in dash, 'Missing htmx afterSwap handler'
assert 'bulk-form' in dash, 'Missing bulk-form wrapper'

print('ALL TEMPLATE CHECKS PASSED')
"
```
  </verify>
  <done>Dashboard has checkboxes per row, select-all header checkbox, bulk action bar with status dropdown and apply button, export CSV/JSON links with filter parameters, and JavaScript for checkbox state management including htmx swap recovery.</done>
</task>

</tasks>

<verification>
1. Load dashboard -- checkbox column visible with select-all in header
2. Check 3 jobs -- bulk bar appears showing "3 selected" with status dropdown
3. Select "Saved" from bulk dropdown, click Apply -- all 3 jobs update to "saved" status
4. Click select-all -- all visible checkboxes toggle
5. Click Export CSV -- browser downloads a .csv file with currently filtered jobs
6. Click Export JSON -- browser downloads a .json file
7. Apply a filter (e.g., Score 4+), then export -- exported file contains only filtered jobs
8. Search for a term, then export -- exported file respects the search
</verification>

<success_criteria>
- Checkboxes per row with select-all toggle work
- Bulk action bar appears/hides based on selection count
- Bulk status update changes all selected jobs and logs activity for each
- CSV export downloads with correct headers and date-stamped filename
- JSON export downloads with filtered data
- Export links include current filter and search parameters
- DASH-03 (bulk actions) and DASH-04 (export) fully satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/05-dashboard-core/05-04-SUMMARY.md`
</output>
