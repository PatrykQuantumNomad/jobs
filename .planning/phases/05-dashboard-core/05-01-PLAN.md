---
phase: 05-dashboard-core
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - webapp/db.py
  - models.py
  - webapp/app.py
  - webapp/templates/base.html
autonomous: true

must_haves:
  truths:
    - "FTS5 virtual table exists and indexes title, company, description from jobs table"
    - "FTS5 triggers keep the index synchronized on INSERT, UPDATE, DELETE"
    - "activity_log table exists with dedup_key, event_type, old_value, new_value, detail, created_at"
    - "Existing jobs have a backfilled 'discovered' activity entry"
    - "JobStatus enum has 11 members (2 pipeline + 9 user-facing)"
    - "Existing 'approved' jobs are migrated to 'saved', 'skipped' to 'withdrawn'"
    - "STATUSES list in app.py reflects the new 9 user-facing statuses"
    - "CSS classes exist for all 11 status values"
  artifacts:
    - path: "webapp/db.py"
      provides: "Schema version 5, FTS5 table+triggers, activity_log table, log_activity(), get_activity_log()"
      contains: "SCHEMA_VERSION = 5"
    - path: "models.py"
      provides: "Expanded JobStatus enum with 11 members"
      contains: "GHOSTED"
    - path: "webapp/app.py"
      provides: "Updated STATUSES list with 9 user-facing statuses"
      contains: "saved"
    - path: "webapp/templates/base.html"
      provides: "CSS classes for all 11 status values"
      contains: "status-ghosted"
  key_links:
    - from: "webapp/db.py"
      to: "SQLite FTS5"
      via: "CREATE VIRTUAL TABLE jobs_fts"
      pattern: "jobs_fts USING fts5"
    - from: "webapp/db.py"
      to: "activity_log"
      via: "log_activity function"
      pattern: "def log_activity"
    - from: "webapp/db.py"
      to: "models.py"
      via: "status vocabulary alignment"
      pattern: "saved.*withdrawn"
---

<objective>
Database schema migration (v3 to v5) adding FTS5 full-text search index, activity_log table, and expanded status vocabulary. Updates JobStatus enum in models.py, STATUSES list in app.py, and CSS classes in base.html.

Purpose: Foundation layer that all other Phase 5 plans depend on -- search needs FTS5, activity log needs the table, bulk actions need the new statuses.
Output: Schema at version 5 with FTS5 working, activity_log table populated with backfilled discovery events, status vocabulary expanded from 6 to 11 values.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-dashboard-core/05-RESEARCH.md

@webapp/db.py
@models.py
@webapp/app.py
@webapp/templates/base.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Schema migration v4 (FTS5 + activity_log) and v5 (status vocabulary)</name>
  <files>webapp/db.py, models.py</files>
  <action>
In webapp/db.py:

1. Update SCHEMA_VERSION from 3 to 5.

2. Add migration version 4 to MIGRATIONS dict with these SQL statements (in order):
   a. CREATE VIRTUAL TABLE jobs_fts:
      ```sql
      CREATE VIRTUAL TABLE IF NOT EXISTS jobs_fts USING fts5(
          title, company, description,
          content='jobs',
          content_rowid=rowid
      )
      ```
   b. Three triggers to keep FTS index synchronized:
      - jobs_fts_ai: AFTER INSERT on jobs -> INSERT into jobs_fts(rowid, title, company, description)
      - jobs_fts_ad: AFTER DELETE on jobs -> INSERT into jobs_fts(jobs_fts, rowid, title, company, description) VALUES('delete', ...)
      - jobs_fts_au: AFTER UPDATE on jobs -> delete old + insert new (two INSERT statements)
      Use IF NOT EXISTS on all triggers.
   c. Rebuild FTS index for existing data: INSERT INTO jobs_fts(jobs_fts) VALUES('rebuild')
   d. CREATE TABLE activity_log:
      ```sql
      CREATE TABLE IF NOT EXISTS activity_log (
          id INTEGER PRIMARY KEY AUTOINCREMENT,
          dedup_key TEXT NOT NULL,
          event_type TEXT NOT NULL,
          old_value TEXT,
          new_value TEXT,
          detail TEXT,
          created_at TEXT NOT NULL DEFAULT (datetime('now'))
      )
      ```
   e. CREATE INDEX idx_activity_dedup ON activity_log(dedup_key)
   f. CREATE INDEX idx_activity_created ON activity_log(created_at)
   g. Backfill discovered events for existing jobs:
      ```sql
      INSERT INTO activity_log (dedup_key, event_type, new_value, created_at)
      SELECT dedup_key, 'discovered', platform, COALESCE(first_seen_at, created_at)
      FROM jobs
      ```

   IMPORTANT: The FTS5 virtual table and triggers use non-standard SQL that cannot be run via conn.execute() one statement at a time like ALTER TABLE. The VIRTUAL TABLE creation and triggers must each be a single string in the migration list. The 'rebuild' command is also a single string.

3. Add migration version 5 to MIGRATIONS dict:
   a. UPDATE jobs SET status = 'saved' WHERE status = 'approved'
   b. UPDATE jobs SET status = 'withdrawn' WHERE status = 'skipped'

4. Update migrate_db() to handle the FTS5 migration correctly. The current error handler catches "duplicate column name" for ALTER TABLE idempotency. For version 4, also catch and skip "already exists" errors (for the IF NOT EXISTS statements). Add a check: if "already exists" in str(exc).lower(), continue.

5. Add two new query functions:
   ```python
   def log_activity(
       dedup_key: str,
       event_type: str,
       old_value: str | None = None,
       new_value: str | None = None,
       detail: str | None = None,
   ) -> None:
       with get_conn() as conn:
           conn.execute(
               """INSERT INTO activity_log (dedup_key, event_type, old_value, new_value, detail)
                  VALUES (?, ?, ?, ?, ?)""",
               (dedup_key, event_type, old_value, new_value, detail),
           )

   def get_activity_log(dedup_key: str) -> list[dict]:
       with get_conn() as conn:
           rows = conn.execute(
               "SELECT * FROM activity_log WHERE dedup_key = ? ORDER BY created_at DESC",
               (dedup_key,),
           ).fetchall()
       return [dict(row) for row in rows]
   ```

6. Modify update_job_status() to also log activity: before the UPDATE, fetch the current status with get_job(dedup_key), then after the UPDATE, call log_activity(dedup_key, "status_change", old_value=old_status, new_value=status).

7. Modify update_job_notes() to also log activity: call log_activity(dedup_key, "note_added", detail=notes) after the UPDATE.

In models.py:

8. Replace the JobStatus enum with the expanded 11-member version:
   ```python
   class JobStatus(str, Enum):
       # Pipeline-managed (set by orchestrator)
       DISCOVERED = "discovered"
       SCORED = "scored"
       # User-managed (set from dashboard)
       SAVED = "saved"
       APPLIED = "applied"
       PHONE_SCREEN = "phone_screen"
       TECHNICAL = "technical"
       FINAL_INTERVIEW = "final_interview"
       OFFER = "offer"
       REJECTED = "rejected"
       WITHDRAWN = "withdrawn"
       GHOSTED = "ghosted"
   ```
   Remove APPROVED and SKIPPED (they are migrated to SAVED and WITHDRAWN).
  </action>
  <verify>
Run in Python to verify schema migration works:
```bash
cd /Users/patrykattc/work/jobs && JOBFLOW_TEST_DB=1 python -c "
from webapp import db
conn = db.get_conn()
# Check version
v = conn.execute('PRAGMA user_version').fetchone()[0]
assert v == 5, f'Expected version 5, got {v}'
# Check FTS5 table exists
tables = [r[0] for r in conn.execute(\"SELECT name FROM sqlite_master WHERE type='table'\").fetchall()]
assert 'jobs_fts' in tables, f'jobs_fts not in {tables}'
# Check activity_log table exists
assert 'activity_log' in tables, f'activity_log not in {tables}'
# Check triggers exist
triggers = [r[0] for r in conn.execute(\"SELECT name FROM sqlite_master WHERE type='trigger'\").fetchall()]
assert 'jobs_fts_ai' in triggers, f'Missing insert trigger'
assert 'jobs_fts_ad' in triggers, f'Missing delete trigger'
assert 'jobs_fts_au' in triggers, f'Missing update trigger'
# Check log_activity and get_activity_log functions exist
assert hasattr(db, 'log_activity')
assert hasattr(db, 'get_activity_log')
# Check JobStatus enum
from models import JobStatus
assert len(JobStatus) == 11, f'Expected 11 statuses, got {len(JobStatus)}'
assert 'ghosted' in [s.value for s in JobStatus]
assert 'approved' not in [s.value for s in JobStatus]
print('ALL CHECKS PASSED')
"
```
  </verify>
  <done>Schema version is 5. FTS5 virtual table with 3 sync triggers exists. activity_log table with indexes exists. log_activity() and get_activity_log() functions work. update_job_status() and update_job_notes() log activity. JobStatus enum has 11 members. Old 'approved'/'skipped' statuses removed from enum.</done>
</task>

<task type="auto">
  <name>Task 2: Update STATUSES list in app.py and CSS classes in base.html</name>
  <files>webapp/app.py, webapp/templates/base.html</files>
  <action>
In webapp/app.py:

1. Replace the STATUSES list:
   ```python
   STATUSES = [
       "discovered", "scored", "saved", "applied",
       "phone_screen", "technical", "final_interview",
       "offer", "rejected", "withdrawn", "ghosted",
   ]
   ```

In webapp/templates/base.html:

2. Replace the existing 6 status CSS classes in the style block with all 11:
   ```css
   .status-discovered { background: #e5e7eb; color: #374151; }
   .status-scored { background: #dbeafe; color: #1d4ed8; }
   .status-saved { background: #d1fae5; color: #065f46; }
   .status-applied { background: #c4b5fd; color: #5b21b6; }
   .status-phone_screen { background: #fef3c7; color: #92400e; }
   .status-technical { background: #fed7aa; color: #9a3412; }
   .status-final_interview { background: #fbcfe8; color: #9d174d; }
   .status-offer { background: #bbf7d0; color: #166534; }
   .status-rejected { background: #fee2e2; color: #991b1b; }
   .status-withdrawn { background: #e2e8f0; color: #475569; }
   .status-ghosted { background: #f3e8ff; color: #7c3aed; }
   ```
   Remove the old .status-approved and .status-skipped classes (those statuses no longer exist).
  </action>
  <verify>
```bash
cd /Users/patrykattc/work/jobs && python -c "
from webapp.app import STATUSES
assert len(STATUSES) == 11, f'Expected 11 statuses, got {len(STATUSES)}'
assert 'saved' in STATUSES
assert 'ghosted' in STATUSES
assert 'approved' not in STATUSES
assert 'skipped' not in STATUSES
print('STATUSES OK')
" && grep -c 'status-ghosted' webapp/templates/base.html && echo "CSS OK"
```
  </verify>
  <done>STATUSES list has 11 values. base.html has CSS classes for all 11 status values. Old 'approved' and 'skipped' CSS classes removed.</done>
</task>

</tasks>

<verification>
1. `JOBFLOW_TEST_DB=1 python -c "from webapp import db; print(db.get_conn().execute('PRAGMA user_version').fetchone()[0])"` outputs `5`
2. `python -c "from models import JobStatus; print(len(JobStatus))"` outputs `11`
3. `python -c "from webapp.app import STATUSES; print(len(STATUSES))"` outputs `11`
4. `grep 'status-ghosted' webapp/templates/base.html` finds the CSS class
5. Schema migration is idempotent -- running init_db() twice causes no errors
</verification>

<success_criteria>
- Schema version 5 with FTS5 virtual table, 3 sync triggers, activity_log table, and status vocabulary migration
- JobStatus enum expanded from 6 to 11 members (APPROVED/SKIPPED removed, 7 new user-facing statuses added)
- STATUSES list and CSS classes updated to match
- Activity logging integrated into update_job_status() and update_job_notes()
- All migrations idempotent
</success_criteria>

<output>
After completion, create `.planning/phases/05-dashboard-core/05-01-SUMMARY.md`
</output>
