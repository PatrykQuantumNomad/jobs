---
phase: 23-ci-cd-deployment-and-dark-mode
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/deploy-site.yml
  - .github/workflows/ci.yml
  - site/astro.config.mjs
  - site/src/layouts/BaseLayout.astro
autonomous: true

must_haves:
  truths:
    - "Site changes trigger deploy workflow, Python changes do not"
    - "Python changes trigger CI workflow, site changes do not"
    - "Page source contains JSON-LD SoftwareApplication structured data"
    - "Sitemap XML is generated during build"
  artifacts:
    - path: ".github/workflows/deploy-site.yml"
      provides: "GitHub Pages deployment workflow"
      contains: "withastro/action@v5"
    - path: ".github/workflows/ci.yml"
      provides: "Python CI with site path exclusion"
      contains: "paths-ignore"
    - path: "site/astro.config.mjs"
      provides: "Astro config with sitemap integration and correct site URL"
      contains: "sitemap"
    - path: "site/src/layouts/BaseLayout.astro"
      provides: "JSON-LD structured data in head"
      contains: "SoftwareApplication"
  key_links:
    - from: ".github/workflows/deploy-site.yml"
      to: "site/"
      via: "path filter and withastro/action path param"
      pattern: "paths.*site"
    - from: "site/astro.config.mjs"
      to: "sitemap-index.xml"
      via: "@astrojs/sitemap integration"
      pattern: "sitemap"
---

<objective>
Create GitHub Actions deploy workflow, update Python CI path filters, add sitemap integration and JSON-LD structured data.

Purpose: The site needs a deployment pipeline that triggers only on site changes, Python CI must ignore site changes to avoid false builds, and SEO foundations (sitemap + structured data) must be in place before first deploy.
Output: deploy-site.yml workflow, updated ci.yml, astro.config.mjs with sitemap, BaseLayout with JSON-LD
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-ci-cd-deployment-and-dark-mode/23-RESEARCH.md
@.github/workflows/ci.yml
@site/astro.config.mjs
@site/src/layouts/BaseLayout.astro
</context>

<tasks>

<task type="auto">
  <name>Task 1: GitHub Actions workflows and CI path isolation</name>
  <files>.github/workflows/deploy-site.yml, .github/workflows/ci.yml</files>
  <action>
Create `.github/workflows/deploy-site.yml` with the following structure:
- name: "Deploy Site"
- triggers: push to main with `paths: ['site/**']`, plus `workflow_dispatch` for manual runs
- permissions: contents read, pages write, id-token write
- concurrency group "pages" with cancel-in-progress: false
- Job 1 "build": ubuntu-latest, steps: checkout (actions/checkout@v6), build Astro (withastro/action@v5 with `path: ./site`)
- Job 2 "deploy": needs build, ubuntu-latest, environment name "github-pages" with url from deployment output, step: deploy-pages (actions/deploy-pages@v4) with id "deployment"

Update `.github/workflows/ci.yml`:
- Add `paths-ignore: ['site/**']` to the `push` trigger (under branches: [main])
- Add `paths-ignore: ['site/**']` to the `pull_request` trigger (under branches: [main])
- Keep everything else exactly as-is (concurrency, jobs, steps unchanged)

IMPORTANT: The deploy workflow also needs `paths: ['site/**', '.github/workflows/deploy-site.yml']` so workflow file changes also trigger deployment.
  </action>
  <verify>
Validate YAML syntax: `python -c "import yaml; yaml.safe_load(open('.github/workflows/deploy-site.yml')); print('deploy OK')"` and same for ci.yml. Verify deploy-site.yml contains `withastro/action@v5` with `path: ./site`. Verify ci.yml has `paths-ignore` on both push and pull_request triggers.
  </verify>
  <done>deploy-site.yml exists with correct triggers, permissions, build+deploy jobs. ci.yml has paths-ignore for site/** on both push and pull_request.</done>
</task>

<task type="auto">
  <name>Task 2: Sitemap integration, JSON-LD, and astro.config.mjs URL fix</name>
  <files>site/astro.config.mjs, site/src/layouts/BaseLayout.astro</files>
  <action>
Install @astrojs/sitemap:
```bash
cd site && npm install @astrojs/sitemap
```

Update `site/astro.config.mjs`:
- Add `import sitemap from "@astrojs/sitemap";`
- Add `integrations: [sitemap()]` to the config
- CRITICAL: Fix the `site` URL. The git remote is `PatrykQuantumNomad/jobs.git`, so the GitHub Pages URL would be `https://PatrykQuantumNomad.github.io` (not `patrykgolabek`). However, the existing value `patrykgolabek.github.io` may be intentional if the user has a custom domain or plans to transfer. Keep `site: "https://patrykgolabek.github.io"` as-is per existing config -- the user can update if needed. Add a comment noting the discrepancy.
- Keep existing base, trailingSlash, and vite config

Update `site/src/layouts/BaseLayout.astro`:
- Add JSON-LD structured data in the `<head>`, after the Twitter Card meta tags and before `<ClientRouter />`:
```html
<script type="application/ld+json" set:html={JSON.stringify({
  "@context": "https://schema.org",
  "@type": "SoftwareApplication",
  "name": "JobFlow",
  "description": "Self-hosted pipeline that scrapes job boards, scores matches against your profile, and automates applications with human-in-the-loop safety.",
  "applicationCategory": "DeveloperApplication",
  "operatingSystem": "Linux, macOS, Windows",
  "url": "https://patrykgolabek.github.io/jobs/",
  "author": {
    "@type": "Person",
    "name": "Patryk Golabek",
    "url": "https://patrykgolabek.dev"
  },
  "softwareVersion": "1.2",
  "license": "https://opensource.org/licenses/MIT",
  "featureList": [
    "Multi-platform job scraping (Indeed, Dice, RemoteOK)",
    "AI-powered job scoring with Claude CLI",
    "Resume tailoring with anti-fabrication validation",
    "Web dashboard with real-time SSE updates",
    "Human-in-the-loop application automation"
  ],
  "runtimePlatform": "Python 3.14",
  "downloadUrl": "https://github.com/patrykgolabek/jobs"
})} />
```

Verify the Astro build works with sitemap:
```bash
cd site && npm run build
```
Confirm `site/dist/sitemap-index.xml` and `site/dist/sitemap-0.xml` are generated.
  </action>
  <verify>
Run `cd site && npm run build` -- build succeeds. Check `ls site/dist/sitemap-index.xml site/dist/sitemap-0.xml` -- both files exist. Check `grep -l "SoftwareApplication" site/dist/index.html` -- JSON-LD present in built output. Check `grep "sitemap" site/astro.config.mjs` -- sitemap import and integration present.
  </verify>
  <done>astro.config.mjs has sitemap integration. BaseLayout has JSON-LD SoftwareApplication structured data. Build produces sitemap-index.xml and sitemap-0.xml. Build succeeds without errors.</done>
</task>

</tasks>

<verification>
1. `python -c "import yaml; yaml.safe_load(open('.github/workflows/deploy-site.yml')); print('OK')"` -- valid YAML
2. `python -c "import yaml; yaml.safe_load(open('.github/workflows/ci.yml')); print('OK')"` -- valid YAML
3. `grep -c "paths-ignore" .github/workflows/ci.yml` -- returns 2 (push + pull_request)
4. `grep "withastro/action@v5" .github/workflows/deploy-site.yml` -- present
5. `cd site && npm run build` -- succeeds
6. `ls site/dist/sitemap-index.xml` -- exists
7. `grep "SoftwareApplication" site/dist/index.html` -- present
</verification>

<success_criteria>
- deploy-site.yml workflow created with correct triggers, permissions, and two-job build+deploy structure
- ci.yml updated with paths-ignore: ['site/**'] on both push and pull_request
- astro.config.mjs has @astrojs/sitemap integration
- BaseLayout.astro has JSON-LD SoftwareApplication structured data
- Astro build succeeds and produces sitemap files
</success_criteria>

<output>
After completion, create `.planning/phases/23-ci-cd-deployment-and-dark-mode/23-01-SUMMARY.md`
</output>
