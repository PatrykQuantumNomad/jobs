---
phase: 23-ci-cd-deployment-and-dark-mode
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - site/src/styles/global.css
  - site/src/layouts/BaseLayout.astro
  - site/src/components/ui/ThemeToggle.astro
  - site/src/components/ui/ScreenshotFrame.astro
  - site/src/components/sections/Hero.astro
  - site/src/components/sections/Stats.astro
  - site/src/components/sections/Features.astro
  - site/src/components/sections/TechStack.astro
  - site/src/components/sections/Architecture.astro
  - site/src/components/sections/CodeSnippets.astro
  - site/src/components/sections/Timeline.astro
  - site/src/components/sections/QuickStart.astro
  - site/src/components/sections/Footer.astro
  - site/src/pages/index.astro
autonomous: true

must_haves:
  truths:
    - "Site respects prefers-color-scheme and renders dark mode automatically"
    - "A toggle lets users manually switch between light and dark mode"
    - "Theme persists across page refreshes via localStorage"
    - "No flash of unstyled content (FOUC) when loading in dark mode"
    - "All sections render with readable contrast in both light and dark modes"
  artifacts:
    - path: "site/src/styles/global.css"
      provides: "Tailwind dark mode custom variant"
      contains: "@custom-variant dark"
    - path: "site/src/components/ui/ThemeToggle.astro"
      provides: "Sun/moon toggle button for dark mode"
      min_lines: 15
    - path: "site/src/layouts/BaseLayout.astro"
      provides: "Theme detection scripts and dark body classes"
      contains: "data-theme"
  key_links:
    - from: "site/src/styles/global.css"
      to: "dark: utility classes in components"
      via: "@custom-variant dark directive"
      pattern: "@custom-variant dark"
    - from: "site/src/layouts/BaseLayout.astro"
      to: "localStorage"
      via: "is:inline theme script in head"
      pattern: "localStorage.*theme"
    - from: "site/src/components/ui/ThemeToggle.astro"
      to: "document.documentElement"
      via: "setAttribute data-theme on click"
      pattern: "data-theme"
---

<objective>
Add dark mode support with system preference detection, manual toggle, and dark: utility classes on all section components.

Purpose: The site must support both light and dark color schemes (DSGN-03). This plan adds the Tailwind v4 dark mode infrastructure, FOUC-preventing theme scripts, a ThemeToggle component, and dark: class variants on every section for full dark mode coverage.
Output: Working dark mode with toggle, all sections rendering correctly in both themes
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-ci-cd-deployment-and-dark-mode/23-RESEARCH.md
@site/src/styles/global.css
@site/src/layouts/BaseLayout.astro
@site/src/pages/index.astro
@site/src/components/ui/ScreenshotFrame.astro
@site/src/components/sections/Hero.astro
@site/src/components/sections/Stats.astro
@site/src/components/sections/Features.astro
@site/src/components/sections/TechStack.astro
@site/src/components/sections/Architecture.astro
@site/src/components/sections/CodeSnippets.astro
@site/src/components/sections/Timeline.astro
@site/src/components/sections/QuickStart.astro
@site/src/components/sections/Footer.astro
</context>

<tasks>

<task type="auto">
  <name>Task 1: Dark mode infrastructure -- global.css, BaseLayout scripts, ThemeToggle component</name>
  <files>site/src/styles/global.css, site/src/layouts/BaseLayout.astro, site/src/components/ui/ThemeToggle.astro</files>
  <action>
**global.css:** Add the `@custom-variant dark` directive AFTER the `@import "tailwindcss"` line and BEFORE the `@theme` block:
```css
@custom-variant dark (&:where([data-theme=dark], [data-theme=dark] *));
```
Do NOT nest this inside `@theme`. Do NOT modify the existing `@theme` tokens. The `@custom-variant` line goes between the `@import` and `@theme`.

**BaseLayout.astro:**
1. Add an `is:inline` script in the `<head>`, BEFORE any stylesheets/fonts are imported (right after `<meta name="viewport">`), to prevent FOUC:
```html
<script is:inline>
  ;(function() {
    const stored = localStorage.getItem('theme');
    const systemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    const theme = stored === 'dark' || stored === 'light'
      ? stored
      : (systemDark ? 'dark' : 'light');
    document.documentElement.setAttribute('data-theme', theme);
    document.documentElement.style.colorScheme = theme;
  })();
</script>
```

2. Add a SEPARATE (NOT is:inline) script for ClientRouter persistence, placed right before the closing `</head>`:
```html
<script>
  document.addEventListener('astro:after-swap', () => {
    const stored = localStorage.getItem('theme');
    const systemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    const theme = stored === 'dark' || stored === 'light'
      ? stored
      : (systemDark ? 'dark' : 'light');
    document.documentElement.setAttribute('data-theme', theme);
    document.documentElement.style.colorScheme = theme;
  });
</script>
```

3. Update the `<body>` class to include dark variants:
```html
<body class="bg-surface-50 dark:bg-surface-950 text-surface-900 dark:text-surface-50 font-sans antialiased">
```

**ThemeToggle.astro:** Create `site/src/components/ui/ThemeToggle.astro`:
- A `<button>` with `aria-label="Toggle theme"` and `id="theme-toggle"`
- Contains two inline SVG icons (sun and moon), each 20x20, using `stroke="currentColor"` style
- Sun icon: visible in dark mode, hidden in light mode (use `hidden dark:block` / `block dark:hidden`)
- Moon icon: visible in light mode, hidden in dark mode
- Styling: `p-2 rounded-lg text-surface-600 dark:text-surface-300 hover:bg-surface-200 dark:hover:bg-surface-700 transition-colors`
- Script block (NOT is:inline) that adds a click handler:
  - On click: read current `data-theme` from `<html>`, toggle to opposite
  - Set `data-theme` attribute on `<html>`
  - Set `document.documentElement.style.colorScheme` to new theme
  - Save to `localStorage.setItem('theme', newTheme)`

Sun SVG (simplified): `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>`

Moon SVG (simplified): `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>`
  </action>
  <verify>
Run `cd site && npm run build` -- build succeeds. Verify global.css contains `@custom-variant dark`. Verify BaseLayout.astro contains both `is:inline` theme script and `astro:after-swap` listener (separate scripts). Verify ThemeToggle.astro exists and contains localStorage logic. Verify body has `dark:bg-surface-950 dark:text-surface-50` classes.
  </verify>
  <done>Dark mode infrastructure in place: @custom-variant dark directive, FOUC-preventing head script, ClientRouter persistence script, dark body classes, and ThemeToggle component with sun/moon icons and localStorage persistence.</done>
</task>

<task type="auto">
  <name>Task 2: Dark mode classes on all sections and page composition</name>
  <files>site/src/components/ui/ScreenshotFrame.astro, site/src/components/sections/Hero.astro, site/src/components/sections/Stats.astro, site/src/components/sections/Features.astro, site/src/components/sections/TechStack.astro, site/src/components/sections/Architecture.astro, site/src/components/sections/CodeSnippets.astro, site/src/components/sections/Timeline.astro, site/src/components/sections/QuickStart.astro, site/src/components/sections/Footer.astro, site/src/pages/index.astro</files>
  <action>
Apply dark: utility class pairs to every section component. Follow the color mapping from research:

**Color mapping reference:**
- `bg-white` -> add `dark:bg-surface-950`
- `bg-surface-50` -> add `dark:bg-surface-900`
- `bg-surface-100` -> add `dark:bg-surface-800`
- `text-surface-900` -> add `dark:text-surface-50`
- `text-surface-700` -> add `dark:text-surface-200`
- `text-surface-600` -> add `dark:text-surface-300`
- `text-surface-500` -> add `dark:text-surface-400`
- `text-surface-400` -> add `dark:text-surface-500` (inverse for muted text)
- `border-surface-200` -> add `dark:border-surface-700`
- `border-surface-300` -> add `dark:border-surface-600`
- `bg-primary-50` -> add `dark:bg-primary-950`
- `bg-primary-100` -> add `dark:bg-primary-900`
- `text-primary-500` -> add `dark:text-primary-400`
- `text-primary-600` -> add `dark:text-primary-400`
- `text-primary-700` -> add `dark:text-primary-300`
- `border-primary-200` -> add `dark:border-primary-800`
- `border-primary-300` -> add `dark:border-primary-700`
- `hover:border-surface-400` -> add `dark:hover:border-surface-500`
- `hover:text-surface-900` -> add `dark:hover:text-surface-100`
- `hover:border-primary-200` -> add `dark:hover:border-primary-700`
- `hover:border-primary-300` -> add `dark:hover:border-primary-600`

**Per-component specifics:**

**ScreenshotFrame.astro:**
- Outer div border: add `dark:border-surface-700`
- Title bar bg: `bg-surface-100` -> add `dark:bg-surface-800`
- Title bar border: add `dark:border-surface-700`
- URL text: already `text-surface-400`, add `dark:text-surface-500`

**Hero.astro:**
- h1: add `dark:text-surface-50`
- p: add `dark:text-surface-300`
- "See Features" button border: add `dark:border-surface-600 dark:text-surface-200 dark:hover:border-surface-500 dark:hover:text-surface-100`

**Stats.astro:**
- Already dark (bg-primary-900 text-white). No changes needed.

**Features.astro:**
- Section bg: `bg-white` -> add `dark:bg-surface-950`
- h2: add `dark:text-surface-50`
- Subtitle p: add `dark:text-surface-300`
- Card: `bg-surface-50` -> add `dark:bg-surface-900`, border add `dark:border-surface-700`, hover border add `dark:hover:border-primary-600`
- Icon container: `bg-primary-100` -> add `dark:bg-primary-900`, `text-primary-600` -> add `dark:text-primary-400`
- Card h3: add `dark:text-surface-50`
- Category span: `text-primary-500` -> add `dark:text-primary-400`
- Card p: add `dark:text-surface-300`

**TechStack.astro:**
- Section bg: `bg-surface-50` -> add `dark:bg-surface-900`
- h2: add `dark:text-surface-50`
- Subtitle p: add `dark:text-surface-300`
- Badge card: `bg-white` -> add `dark:bg-surface-800`, border add `dark:border-surface-700`, hover shadow/border add `dark:hover:border-primary-700`
- Icon bg: `bg-primary-50` -> add `dark:bg-primary-950`, text add `dark:text-primary-400`
- Name span: add `dark:text-surface-50`
- Role span: add `dark:text-surface-400`

**Architecture.astro:**
- Section bg: `bg-white` -> add `dark:bg-surface-950`
- h2: add `dark:text-surface-50`
- Subtitle p: add `dark:text-surface-300`
- Phase name h3: add `dark:text-surface-50`
- Phase description: add `dark:text-surface-400`
- Arrow icon: `text-primary-300` -> add `dark:text-primary-600`

**CodeSnippets.astro:**
- Already dark (bg-surface-900). Minimal changes:
- Section bg: keep `bg-surface-900`, add `dark:bg-surface-950` for slightly darker in dark mode
- Card border: already `border-surface-700`, fine as-is
- Header bg: `bg-surface-800` -> fine as-is

**Timeline.astro:**
- Section bg: `bg-surface-50` -> add `dark:bg-surface-900`
- h2: add `dark:text-surface-50`
- Subtitle: add `dark:text-surface-300`
- Timeline border-l: `border-primary-200` -> add `dark:border-primary-800`
- Milestone title h3: add `dark:text-surface-50`
- Date/stats p: add `dark:text-surface-400`
- Description p: add `dark:text-surface-300`
- Feature tags: `bg-primary-50 text-primary-700` -> add `dark:bg-primary-950 dark:text-primary-300`

**QuickStart.astro:**
- Section bg: `bg-white` -> add `dark:bg-surface-950`
- h2: add `dark:text-surface-50`
- Subtitle: add `dark:text-surface-300`
- Step title h3: add `dark:text-surface-50`

**Footer.astro:**
- Already dark (bg-surface-900 text-surface-300). Minimal changes:
- bg: keep `bg-surface-900`, add `dark:bg-surface-950`
- Border-t: already `border-surface-700`, fine as-is

**index.astro:**
- Import and place ThemeToggle component. Add it as a fixed-position button in the top-right corner:
```astro
import ThemeToggle from "../components/ui/ThemeToggle.astro";
```
Place `<ThemeToggle />` inside the BaseLayout slot, BEFORE `<main>`, wrapped in a fixed-position container:
```html
<div class="fixed top-4 right-4 z-50">
  <ThemeToggle />
</div>
```
  </action>
  <verify>
Run `cd site && npm run build` -- build succeeds with zero errors. Spot-check built HTML for dark: classes: `grep -c "dark:" site/dist/index.html` should return a significant count (50+). Verify ThemeToggle is rendered: `grep "theme-toggle" site/dist/index.html`.
  </verify>
  <done>All 9 section components + ScreenshotFrame have dark: class variants. ThemeToggle is positioned fixed top-right on the page. Build succeeds. Dark mode renders all sections with appropriate contrast.</done>
</task>

</tasks>

<verification>
1. `cd site && npm run build` -- succeeds with zero errors
2. `grep "@custom-variant dark" site/src/styles/global.css` -- present
3. `grep "data-theme" site/src/layouts/BaseLayout.astro` -- present in both scripts
4. `grep "localStorage" site/src/components/ui/ThemeToggle.astro` -- present
5. `grep -c "dark:" site/dist/index.html` -- returns 50+ (dark utility classes throughout)
6. `grep "theme-toggle" site/dist/index.html` -- ThemeToggle button rendered
7. No `bg-white` without corresponding `dark:bg-surface-*` in any section component
</verification>

<success_criteria>
- @custom-variant dark directive in global.css enables dark: utility classes via data-theme attribute
- BaseLayout has FOUC-preventing is:inline script and ClientRouter astro:after-swap persistence script
- ThemeToggle component with sun/moon icons toggles data-theme and persists to localStorage
- All 9 sections + ScreenshotFrame have dark: class pairs for backgrounds, text, borders, and hover states
- Sections already dark (Stats, CodeSnippets, Footer) have minimal adjustments for consistency
- Build succeeds, no visual regressions in light mode
</success_criteria>

<output>
After completion, create `.planning/phases/23-ci-cd-deployment-and-dark-mode/23-02-SUMMARY.md`
</output>
