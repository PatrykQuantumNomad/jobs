---
phase: 01-config-externalization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - config.py
  - models.py
  - pyproject.toml
  - config.yaml
  - config.example.yaml
autonomous: true

must_haves:
  truths:
    - "AppSettings loads search, scoring, platforms, timing, and schedule sections from config.yaml"
    - "AppSettings loads credentials and personal profile from .env"
    - "Validation errors report all failures at once with field-level messages"
    - "get_settings() returns a cached singleton that is not created at import time"
    - "CandidateProfile can be constructed from AppSettings via build_candidate_profile()"
    - "SearchQueryConfig objects convert to domain SearchQuery objects per platform"
  artifacts:
    - path: "config.py"
      provides: "AppSettings(BaseSettings) with nested sub-models, get_settings(), reset_settings()"
      contains: "class AppSettings"
    - path: "models.py"
      provides: "CandidateProfile without hardcoded defaults (all fields required or empty-string defaults)"
      contains: "class CandidateProfile"
    - path: "pyproject.toml"
      provides: "pydantic-settings[yaml] dependency"
      contains: "pydantic-settings"
    - path: "config.yaml"
      provides: "Working config with current user values for search, scoring, platforms, timing"
      contains: "search:"
    - path: "config.example.yaml"
      provides: "Heavily commented template with placeholder values"
      contains: "# "
  key_links:
    - from: "config.py"
      to: "config.yaml"
      via: "YamlConfigSettingsSource in settings_customise_sources"
      pattern: "YamlConfigSettingsSource"
    - from: "config.py"
      to: "models.py"
      via: "build_candidate_profile() constructs CandidateProfile"
      pattern: "CandidateProfile"
    - from: "config.py"
      to: ".env"
      via: "DotEnvSettingsSource for credentials and personal data"
      pattern: "env_file"
---

<objective>
Create the AppSettings model with pydantic-settings, YAML config files, and the lazy singleton loader. This is the foundation that all other config migration depends on.

Purpose: Replace the hardcoded Config class with a validated, multi-source settings model that loads from config.yaml (non-sensitive) and .env (sensitive/personal).
Output: New config.py with AppSettings, config.yaml with current values, config.example.yaml with commented template, updated pyproject.toml and models.py.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-config-externalization/01-CONTEXT.md
@.planning/phases/01-config-externalization/01-RESEARCH.md
@config.py
@models.py
@pyproject.toml
@.planning/codebase/CONVENTIONS.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AppSettings model and sub-models in config.py</name>
  <files>config.py, pyproject.toml</files>
  <action>
  Complete rewrite of config.py. Replace the `Config` class with a pydantic-settings `AppSettings(BaseSettings)` model.

  **pyproject.toml:** Add `"pydantic-settings[yaml]>=2.12.0"` to the `dependencies` list. Then run `pip install -e ".[dev]"` to install.

  **config.py structure (replace entire file):**

  1. Sub-models (all inherit `BaseModel`, NOT `BaseSettings`):
     - `SearchQueryConfig`: title (str), keywords (list[str], default=[]), location (str, default=""), platforms (list[str], default=[]), max_pages (int, default=5, ge=1, le=10)
     - `SearchConfig`: queries (list[SearchQueryConfig]), min_salary (int, default=150_000)
     - `ScoringWeights`: title_match (float, default=2.0, ge=0), tech_overlap (float, default=2.0, ge=0), remote (float, default=1.0, ge=0), salary (float, default=1.0, ge=0)
     - `ScoringConfig`: target_titles (list[str]), tech_keywords (list[str]), weights (ScoringWeights, default=ScoringWeights())
     - `PlatformToggle`: enabled (bool, default=True)
     - `PlatformsConfig`: indeed (PlatformToggle, default), dice (PlatformToggle, default), remoteok (PlatformToggle, default)
     - `TimingConfig`: nav_delay_min (float, 2.0), nav_delay_max (float, 5.0), form_delay_min (float, 1.0), form_delay_max (float, 2.0), page_load_timeout (int, 30_000)
     - `ScheduleConfig`: empty model (placeholder for Phase 4)

  2. Root `AppSettings(BaseSettings)`:
     - `model_config = SettingsConfigDict(yaml_file="config.yaml", env_file=".env", env_file_encoding="utf-8", extra="ignore")` -- use `extra="ignore"` on root to avoid rejecting unexpected env vars
     - YAML sections: search (SearchConfig), scoring (ScoringConfig), platforms (PlatformsConfig, default), timing (TimingConfig, default), schedule (ScheduleConfig, default)
     - .env credentials: indeed_email (str | None = None), dice_email (str | None = None), dice_password (str | None = None)
     - .env personal profile: candidate_first_name, candidate_last_name, candidate_email, candidate_phone, candidate_location, candidate_github, candidate_github_personal, candidate_website, candidate_youtube, candidate_years_experience, candidate_current_title, candidate_current_company, candidate_work_authorization, candidate_willing_to_relocate, candidate_desired_salary, candidate_desired_salary_usd (int, 200_000), candidate_start_date, candidate_education, candidate_resume_path (str, "resumes/Patryk_Golabek_Resume.pdf") -- all str with empty string defaults except noted

     - Override `settings_customise_sources` to return: (init_settings, env_settings, dotenv_settings, YamlConfigSettingsSource(settings_cls))
     - MUST explicitly register `YamlConfigSettingsSource(settings_cls)` -- yaml_file alone does NOT auto-register it (Pitfall 3 from research)

  3. Methods on AppSettings:
     - `build_candidate_profile() -> CandidateProfile`: constructs CandidateProfile from .env fields + scoring.target_titles + scoring.tech_keywords
     - `get_search_queries(platform: str) -> list[SearchQuery]`: converts SearchQueryConfig list to SearchQuery domain objects. For each query config: skip if qcfg.platforms is non-empty and platform not in it; build query string as `'"title"' + ' '.join(keywords)`; create SearchQuery(query=query_str, platform=platform, location=qcfg.location or "", max_pages=qcfg.max_pages)
     - `validate_platform_credentials(platform: str) -> bool`: indeed always True, dice checks dice_email and dice_password, remoteok always True
     - `enabled_platforms() -> list[str]`: returns list of platform names where enabled=True

  4. Standalone functions:
     - `get_settings(config_path: str = "config.yaml") -> AppSettings`: lazy singleton. Uses module-level `_settings: AppSettings | None = None`. On first call, creates `AppSettings()` (pydantic-settings reads yaml_file from SettingsConfigDict). Subsequent calls return cached instance. If config_path differs from "config.yaml", update the yaml_file path before creating.
     - `reset_settings() -> None`: clears cached singleton (for testing)
     - `ensure_directories() -> None`: standalone function (NOT a method on AppSettings). Creates browser_sessions, debug_screenshots, job_pipeline, job_pipeline/descriptions, resumes, resumes/tailored directories. Uses `Path(__file__).parent` as project root.
     - `PROJECT_ROOT = Path(__file__).parent` as module-level constant (directories are computed paths, not user config)
     - Other directory constants: `BROWSER_SESSIONS_DIR`, `DEBUG_SCREENSHOTS_DIR`, `JOB_PIPELINE_DIR`, `JOB_DESCRIPTIONS_DIR`, `RESUMES_DIR`, `RESUMES_TAILORED_DIR` as module-level Path constants

  **CRITICAL:** Do NOT call `ensure_directories()` at module level. Do NOT instantiate AppSettings at import time. The current `Config.ensure_directories()` call at module bottom must be removed. Callers (orchestrator.py) will call `ensure_directories()` explicitly.

  **CRITICAL:** Do NOT use `extra="forbid"` on AppSettings root -- it will reject unrecognized env vars. Use `extra="ignore"` on root. Sub-models can use default (no extra setting needed since they're BaseModel).

  Follow codebase conventions: `from __future__ import annotations`, section markers with `# -- Section --`, type hints using `str | None` style, docstrings on all classes and public methods.
  </action>
  <verify>
  Run `python -c "from config import AppSettings, get_settings, ensure_directories, PROJECT_ROOT; print('imports OK')"` -- should succeed without creating any files or loading config (import-time safety).
  Run `ruff check config.py` -- should pass with no errors.
  </verify>
  <done>config.py contains AppSettings with all sub-models, get_settings(), reset_settings(), ensure_directories(), and directory constants. No import-time side effects. Passes ruff check.</done>
</task>

<task type="auto">
  <name>Task 2: Create config.yaml, config.example.yaml, and update models.py</name>
  <files>config.yaml, config.example.yaml, models.py</files>
  <action>
  **config.yaml** -- Create at project root with Patryk's current values (migrated from hardcoded Config class and CLAUDE.md):

  ```yaml
  search:
    min_salary: 150000
    queries:
      - title: "senior software engineer"
        keywords: []
        location: ""
        max_pages: 5
      - title: "staff software engineer"
        keywords: []
      - title: "principal engineer"
        keywords: []
      - title: "software developer"
        keywords: []
      - title: "full stack engineer"
        keywords: []
      - title: "backend engineer"
        keywords: []
      - title: "devops engineer"
        keywords: []
      - title: "platform engineer"
        keywords: []
      - title: "software architect"
        keywords: []
      - title: "solutions architect"
        keywords: []
      - title: "cloud architect"
        keywords: []
      - title: "AI engineer"
        keywords: []
      - title: "machine learning engineer"
        keywords: []
      - title: "LLM engineer"
        keywords: []
      - title: "site reliability engineer"
        keywords: []
      - title: "cloud engineer"
        keywords: []
      - title: "infrastructure engineer"
        keywords: []
      - title: "kubernetes engineer"
        keywords: []
      - title: "engineering manager"
        keywords: ["software"]
      - title: "technical lead"
        keywords: []
      - title: "engineering director"
        keywords: []
      - title: "head of engineering"
        keywords: []

  scoring:
    target_titles:
      - "Senior Software Engineer"
      - "Principal Engineer"
      - "Staff Engineer"
      - "Platform Engineering Lead"
      - "DevOps Lead"
      - "Engineering Manager"
    tech_keywords:
      - kubernetes
      - k8s
      - gke
      - eks
      - aks
      - terraform
      - terragrunt
      - helm
      - devspace
      - python
      - fastapi
      - go
      - golang
      - java
      - typescript
      - langchain
      - langgraph
      - langflow
      - llm
      - ai/ml
      - agentic
      - prometheus
      - grafana
      - observability
      - airflow
      - kafka
      - postgresql
      - redis
      - docker
      - gitops
      - ci/cd
      - cloud native
      - microservices
      - platform engineering
    weights:
      title_match: 2.0
      tech_overlap: 2.0
      remote: 1.0
      salary: 1.0

  platforms:
    indeed:
      enabled: true
    dice:
      enabled: true
    remoteok:
      enabled: true

  timing:
    nav_delay_min: 2.0
    nav_delay_max: 5.0
    form_delay_min: 1.0
    form_delay_max: 2.0
    page_load_timeout: 30000

  schedule: {}
  ```

  **config.example.yaml** -- Create at project root with heavily commented template. Every field has an inline YAML comment explaining its purpose and valid values. Use placeholder values (not real personal data). Include ALL fields that config.yaml supports. This must be comprehensive enough for a new user to fill in and run immediately. Example comments:
  - `min_salary: 150000  # Minimum annual salary (USD). Jobs below this are filtered out. Set to 0 to disable.`
  - `title: "Senior Software Engineer"  # Job title to search for (wrapped in quotes for exact match)`
  - `keywords: ["Kubernetes", "remote"]  # Additional search terms appended to title`
  - `platforms: ["indeed", "dice"]  # Optional: limit this query to specific platforms. Omit to search all.`
  - `title_match: 2.0  # Weight for title matching (0-10). Higher = more influence on score.`

  Also include a header block explaining:
  - This is the example config -- copy to config.yaml and customize
  - Personal info and credentials go in .env (not here)
  - The file is organized into sections: search, scoring, platforms, timing, schedule

  **models.py** -- Update `CandidateProfile` to remove all hardcoded default values. Change all string fields from having specific defaults (like `first_name: str = "Patryk"`) to empty string defaults (`first_name: str = ""`). Keep `desired_salary_usd: int = 200_000` as a reasonable default. Keep `resume_path: str = "resumes/Patryk_Golabek_Resume.pdf"` as default. Keep `target_titles` and `tech_keywords` with `default_factory=list` (empty list). Leave `Job`, `SearchQuery`, and `JobStatus` models completely unchanged.
  </action>
  <verify>
  1. Verify config.yaml is valid YAML: `python -c "import yaml; yaml.safe_load(open('config.yaml')); print('config.yaml valid')"` (from project root)
  2. Verify config.example.yaml is valid YAML: `python -c "import yaml; yaml.safe_load(open('config.example.yaml')); print('config.example.yaml valid')"` (from project root)
  3. Verify AppSettings loads from config.yaml: `cd /Users/patrykattc/work/jobs && python -c "from config import get_settings; s = get_settings(); print(f'Queries: {len(s.search.queries)}'); print(f'Targets: {len(s.scoring.target_titles)}'); print(f'Tech: {len(s.scoring.tech_keywords)}')"`
  4. Verify CandidateProfile builds: `cd /Users/patrykattc/work/jobs && python -c "from config import get_settings; s = get_settings(); p = s.build_candidate_profile(); print(f'Profile: {p.first_name} {p.last_name}')"` -- should print name from .env or empty strings
  5. Verify search query conversion: `cd /Users/patrykattc/work/jobs && python -c "from config import get_settings; s = get_settings(); qs = s.get_search_queries('indeed'); print(f'{len(qs)} queries for indeed'); print(f'First: {qs[0].query}')"`
  6. `ruff check models.py` -- passes
  </verify>
  <done>config.yaml contains all current values from Config class. config.example.yaml is heavily commented with placeholders. CandidateProfile has no hardcoded personal data. AppSettings successfully loads and constructs all domain objects.</done>
</task>

</tasks>

<verification>
1. `from config import get_settings, ensure_directories, PROJECT_ROOT` -- imports without side effects
2. `get_settings()` returns AppSettings with 22 search queries, 6 target titles, 34 tech keywords
3. `get_settings().build_candidate_profile()` returns a CandidateProfile
4. `get_settings().get_search_queries("indeed")` returns list of SearchQuery objects
5. `get_settings().validate_platform_credentials("dice")` returns bool based on .env
6. `get_settings().enabled_platforms()` returns list of enabled platform names
7. config.yaml and config.example.yaml are both valid YAML
8. `ruff check config.py models.py` passes
9. No import-time side effects (no directories created, no settings loaded on import)
</verification>

<success_criteria>
- AppSettings model exists with all 5 YAML sections (search, scoring, platforms, timing, schedule)
- AppSettings loads credentials and personal profile from .env
- get_settings() is a lazy singleton (not import-time)
- config.yaml has all current hardcoded values
- config.example.yaml has comments on every field
- CandidateProfile in models.py has no hardcoded personal data
- All verification checks pass
</success_criteria>

<output>
After completion, create `.planning/phases/01-config-externalization/01-01-SUMMARY.md`
</output>
