---
phase: 01-config-externalization
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - orchestrator.py
  - scorer.py
  - form_filler.py
autonomous: true

must_haves:
  truths:
    - "Orchestrator uses get_settings() instead of Config class for all configuration"
    - "Orchestrator --validate flag checks config.yaml and .env without running the pipeline"
    - "Scorer accepts scoring weights from config and applies them to score calculation"
    - "FormFiller receives CandidateProfile via constructor or get_settings(), not Config.CANDIDATE"
    - "Pipeline behavior is unchanged -- same search results, same scoring, same output files"
  artifacts:
    - path: "orchestrator.py"
      provides: "Pipeline using get_settings() for all config, --validate flag"
      contains: "get_settings"
    - path: "scorer.py"
      provides: "Scorer accepting CandidateProfile and ScoringWeights from settings"
      contains: "get_settings"
    - path: "form_filler.py"
      provides: "FormFiller using CandidateProfile from settings instead of Config"
      contains: "get_settings"
  key_links:
    - from: "orchestrator.py"
      to: "config.py"
      via: "get_settings() call in run() and phase_0_setup()"
      pattern: "get_settings\\(\\)"
    - from: "scorer.py"
      to: "config.py"
      via: "get_settings().build_candidate_profile() in constructor"
      pattern: "build_candidate_profile"
    - from: "orchestrator.py"
      to: "scorer.py"
      via: "Passes settings-derived profile to JobScorer"
      pattern: "JobScorer"
---

<objective>
Migrate the pipeline core (orchestrator, scorer, form_filler) from the old Config class to the new AppSettings. Add the --validate CLI flag.

Purpose: These three files are the pipeline's brain -- orchestration, scoring, and form filling. Migrating them completes the "pipeline loads from YAML" requirement.
Output: Updated orchestrator.py, scorer.py, and form_filler.py using get_settings() with no Config imports remaining.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-config-externalization/01-CONTEXT.md
@.planning/phases/01-config-externalization/01-RESEARCH.md
@.planning/phases/01-config-externalization/01-01-SUMMARY.md
@orchestrator.py
@scorer.py
@form_filler.py
@config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate scorer.py and form_filler.py to use get_settings()</name>
  <files>scorer.py, form_filler.py</files>
  <action>
  **scorer.py:**

  1. Replace `from config import Config` with `from config import get_settings`
  2. Keep `from models import CandidateProfile, Job, JobStatus`
  3. Update `JobScorer.__init__` to accept optional `profile` and optional `weights` (ScoringWeights):
     - `def __init__(self, profile: CandidateProfile | None = None, weights: ScoringWeights | None = None) -> None:`
     - If profile is None, get it from `get_settings().build_candidate_profile()`
     - If weights is None, get them from `get_settings().scoring.weights`
     - Store both: `self.profile = profile or get_settings().build_candidate_profile()` and `self.weights = weights or get_settings().scoring.weights`
  4. Import ScoringWeights: add `from config import ScoringWeights` (or wherever it lives after Plan 01)
  5. Update scoring methods to use `self.weights` for weight values:
     - `_title_score` currently returns 0, 1, or 2 hardcoded. Keep the raw score logic (0, 1, 2) but multiply by `self.weights.title_match / 2.0` so the weight scales the contribution. Actually -- simpler: keep the raw scoring as-is (0-2 for title, 0-2 for tech, 0-1 for remote, 0-1 for salary). Apply weights in `score_job`: `raw = (self._title_score(job.title) * self.weights.title_match / 2.0 + self._tech_score(job) * self.weights.tech_overlap / 2.0 + self._location_score(job.location) * self.weights.remote + self._salary_score(job) * self.weights.salary)`. Then map raw to 1-5 scale with thresholds (unchanged: raw >= 5 -> 5, >= 4 -> 4, >= 3 -> 3, >= 2 -> 2, else 1).

     IMPORTANT: With default weights (title_match=2.0, tech_overlap=2.0, remote=1.0, salary=1.0), the weighted calculation produces IDENTICAL results to the current hardcoded scoring. Verify: title raw 2 * 2.0/2.0 = 2, tech raw 2 * 2.0/2.0 = 2, remote raw 1 * 1.0 = 1, salary raw 1 * 1.0 = 1 => total 6 => max achievable is 6, which maps to score 5. This matches current behavior exactly.

  **form_filler.py:**

  1. Replace `from config import Config` with `from config import get_settings`
  2. Keep `from models import CandidateProfile`
  3. Update `FormFiller.__init__`: replace `self.profile = profile or Config.CANDIDATE` with `self.profile = profile or get_settings().build_candidate_profile()`
  4. No other changes needed -- the rest of the file uses `self.profile` which is already a CandidateProfile

  Both files: ensure no remaining references to `Config` (class). Follow codebase conventions (section markers, docstrings, type hints).
  </action>
  <verify>
  1. `ruff check scorer.py form_filler.py` -- passes
  2. `python -c "from scorer import JobScorer; print('scorer imports OK')"` -- no import errors
  3. `python -c "from form_filler import FormFiller; print('form_filler imports OK')"` -- no import errors
  4. Verify no remaining Config references: `grep -n "from config import Config" scorer.py form_filler.py` -- should return nothing
  5. Verify default weights produce same scoring: `cd /Users/patrykattc/work/jobs && python -c "
from scorer import JobScorer
from models import Job
scorer = JobScorer()
# Test a job with strong match
job = Job(platform='indeed', title='Senior Software Engineer', company='Test', url='http://test', description='kubernetes terraform python fastapi helm', location='Remote', salary_min=200000, salary_max=250000)
score = scorer.score_job(job)
print(f'Score: {score}')
assert score == 5, f'Expected 5, got {score}'
print('Scoring preserved')
"`
  </verify>
  <done>scorer.py uses get_settings() for profile and scoring weights. form_filler.py uses get_settings() for profile. No Config class references remain. Default weight behavior matches original hardcoded scoring.</done>
</task>

<task type="auto">
  <name>Task 2: Migrate orchestrator.py and add --validate flag</name>
  <files>orchestrator.py</files>
  <action>
  Replace all `Config.X` references with `get_settings()` equivalents. Add `--validate` flag.

  **Import changes:**
  - Replace `from config import Config` with `from config import get_settings, ensure_directories, PROJECT_ROOT, JOB_PIPELINE_DIR, JOB_DESCRIPTIONS_DIR, RESUMES_DIR`
  - Keep all other imports

  **Orchestrator.__init__:**
  - Load settings eagerly in constructor: `self.settings = get_settings()`
  - Create scorer with settings-derived profile and weights: `self.scorer = JobScorer(profile=self.settings.build_candidate_profile(), weights=self.settings.scoring.weights)`

  **phase_0_setup() replacements:**
  - `Config.PROJECT_ROOT / ".env"` -> `PROJECT_ROOT / ".env"`
  - `Config.validate_platform_credentials(p)` -> `self.settings.validate_platform_credentials(p)`
  - `Config.ensure_directories()` -> `ensure_directories()`
  - `Config.RESUME_ATS_PATH` -> `PROJECT_ROOT / self.settings.candidate_resume_path`

  **phase_1_login() replacements:**
  - `Config.validate_platform_credentials("indeed")` -> `self.settings.validate_platform_credentials("indeed")`
  - Same for dice and remoteok

  **phase_2_search() replacements:**
  - `Config.validate_platform_credentials(name)` -> `self.settings.validate_platform_credentials(name)`
  - `Config.get_search_queries(platform=name)` -> `self.settings.get_search_queries(platform=name)`

  **_save_raw() / _save_scored() / _save_descriptions() / _write_tracker():**
  - `Config.JOB_PIPELINE_DIR` -> `JOB_PIPELINE_DIR`
  - `Config.JOB_DESCRIPTIONS_DIR` -> `JOB_DESCRIPTIONS_DIR`

  **_load_raw_results():**
  - `Config.JOB_PIPELINE_DIR` -> `JOB_PIPELINE_DIR`

  **phase_4_apply():**
  - `Config.RESUME_ATS_PATH` -> `PROJECT_ROOT / self.settings.candidate_resume_path`

  **_print_summary():**
  - `Config.JOB_PIPELINE_DIR` -> `JOB_PIPELINE_DIR`

  **run() method:**
  - When platforms is None, use `self.settings.enabled_platforms()` instead of hardcoded `["indeed", "dice", "remoteok"]`

  **CLI (main function) -- add --validate flag:**
  ```python
  parser.add_argument(
      "--validate",
      action="store_true",
      help="Validate config.yaml and .env without running the pipeline",
  )
  ```
  If `args.validate` is set:
  1. Try `get_settings()` -- if it raises `ValidationError`, catch it, format errors nicely (iterate `e.errors()`, print `"{loc}: {msg}"` for each), exit with code 1
  2. If validation passes, print "Config validation passed."
  3. Check .env completeness with warnings (not hard errors):
     - If indeed enabled but no indeed_email: warn
     - If dice enabled but no dice_email or dice_password: warn
  4. Exit with code 0 (do not run the pipeline)

  Import `ValidationError` from `pydantic` for the catch block.

  Ensure no remaining references to `Config` class anywhere in the file.
  </action>
  <verify>
  1. `ruff check orchestrator.py` -- passes
  2. `python -c "from orchestrator import Orchestrator; print('orchestrator imports OK')"` -- no import errors
  3. Verify no remaining Config references: `grep -n "from config import Config" orchestrator.py` -- should return nothing
  4. `grep -n "Config\." orchestrator.py` -- should return nothing (no Config.ATTRIBUTE references)
  5. Test --validate flag: `cd /Users/patrykattc/work/jobs && python orchestrator.py --validate` -- should print "Config validation passed." and any .env warnings, then exit 0
  6. Test --validate with help: `cd /Users/patrykattc/work/jobs && python orchestrator.py --help` -- should show --validate option
  </verify>
  <done>orchestrator.py uses get_settings() for all configuration. --validate flag works for dry-run config checking. No Config class references remain. Pipeline behavior preserved when run normally.</done>
</task>

</tasks>

<verification>
1. `grep -rn "from config import Config" orchestrator.py scorer.py form_filler.py` -- returns nothing
2. `grep -rn "Config\." orchestrator.py scorer.py form_filler.py` -- returns nothing (no Config class references)
3. `ruff check orchestrator.py scorer.py form_filler.py` -- all pass
4. `python orchestrator.py --validate` -- exits 0 with success message
5. `python -c "from scorer import JobScorer; from models import Job; s = JobScorer(); j = Job(platform='indeed', title='Staff Engineer', company='X', url='http://x', location='Remote'); print(s.score_job(j))"` -- returns expected score
</verification>

<success_criteria>
- orchestrator.py, scorer.py, and form_filler.py have zero references to the old Config class
- All three files use get_settings() for configuration access
- Scoring produces identical results with default weights
- --validate flag exits cleanly with validation result
- ruff check passes on all three files
</success_criteria>

<output>
After completion, create `.planning/phases/01-config-externalization/01-02-SUMMARY.md`
</output>
