---
phase: 09-test-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pyproject.toml
  - tests/__init__.py
  - tests/platforms/__init__.py
  - tests/webapp/__init__.py
  - tests/resume_ai/__init__.py
  - tests/fixtures/test_config.yaml
autonomous: true

must_haves:
  truths:
    - "Running `uv run pytest --collect-only` from repo root discovers the tests/ directory and applies strict asyncio mode"
    - "pytest markers unit, integration, e2e, slow are registered and `--strict-markers` prevents typos"
    - "Default `pytest` excludes e2e tests and disables real network sockets"
    - "`pytest --cov` produces a coverage report with correct source/omit configuration"
    - "A test_config.yaml exists with safe defaults that satisfies AppSettings validation"
  artifacts:
    - path: "pyproject.toml"
      provides: "pytest, coverage, and dev dependency configuration"
      contains: "asyncio_mode"
    - path: "tests/__init__.py"
      provides: "Test package root"
    - path: "tests/platforms/__init__.py"
      provides: "Platform test sub-package"
    - path: "tests/webapp/__init__.py"
      provides: "Webapp test sub-package"
    - path: "tests/resume_ai/__init__.py"
      provides: "Resume AI test sub-package"
    - path: "tests/fixtures/test_config.yaml"
      provides: "Safe test configuration with no real credentials"
      contains: "queries"
  key_links:
    - from: "pyproject.toml"
      to: "tests/"
      via: "testpaths configuration"
      pattern: 'testpaths = \["tests"\]'
    - from: "pyproject.toml"
      to: "pytest-socket"
      via: "addopts --disable-socket"
      pattern: "--disable-socket"
---

<objective>
Install test dependencies, configure pytest/coverage in pyproject.toml, create the test directory structure, and provide a safe test config YAML.

Purpose: Establish the foundation that all test files and fixtures will build on -- dependency installation, pytest discovery, marker registration, coverage configuration, and a test-safe YAML config that satisfies AppSettings validation without real credentials.

Output: Updated pyproject.toml with full pytest + coverage config; tests/ directory tree with __init__.py files; tests/fixtures/test_config.yaml with safe defaults.
</objective>

<execution_context>
@/Users/patrykattc/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patrykattc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-test-infrastructure/09-RESEARCH.md
@pyproject.toml
@config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install test dependencies and configure pytest + coverage in pyproject.toml</name>
  <files>pyproject.toml</files>
  <action>
Update the existing pyproject.toml with test infrastructure dependencies and configuration.

**Dev dependencies** -- add to existing `[dependency-groups] dev` list:
```
"factory-boy>=3.3.0",
"Faker>=40.0.0",
"pytest-asyncio>=1.3.0",
"respx>=0.22.0",
"pytest-socket>=0.7.0",
"pytest-cov>=7.0.0",
```

**pytest config** -- replace existing `[tool.pytest.ini_options]` section:
```toml
[tool.pytest.ini_options]
testpaths = ["tests"]
asyncio_mode = "strict"
markers = [
    "unit: Pure logic tests with no I/O",
    "integration: Tests that touch the database or combine modules",
    "e2e: End-to-end browser tests (requires Playwright)",
    "slow: Tests that take more than 5 seconds",
]
addopts = [
    "--disable-socket",
    "--allow-unix-socket",
    "-m", "not e2e",
    "--strict-markers",
]
```

**coverage config** -- add two new sections:
```toml
[tool.coverage.run]
source = [
    "config",
    "models",
    "scorer",
    "salary",
    "dedup",
    "form_filler",
    "orchestrator",
    "platforms",
    "webapp",
    "resume_ai",
    "apply_engine",
]
omit = [
    "*/test_*",
    "*/conftest*",
    "*/__pycache__/*",
    "platforms/stealth.py",
    "platforms/indeed.py",
    "platforms/dice.py",
    "platforms/indeed_selectors.py",
    "platforms/dice_selectors.py",
]

[tool.coverage.report]
show_missing = true
skip_empty = true
exclude_lines = [
    "pragma: no cover",
    "if TYPE_CHECKING:",
    "if __name__ == .__main__.:",
    "pass",
]
```

After editing pyproject.toml, run `uv sync` to install the new dev dependencies.
  </action>
  <verify>
Run: `uv run python -c "import factory; import faker; import respx; import pytest_socket; import pytest_asyncio; import pytest_cov; print('All test deps installed')"` -- should print success message.
Run: `uv run pytest --co -q 2>&1 | head -5` -- should show "no tests ran" (not an error about missing config).
  </verify>
  <done>pyproject.toml has all 6 new dev dependencies, pytest markers/addopts/asyncio_mode configured, coverage source/omit/report configured. `uv sync` succeeds. All test libraries importable.</done>
</task>

<task type="auto">
  <name>Task 2: Create test directory structure and test config YAML</name>
  <files>
tests/__init__.py
tests/platforms/__init__.py
tests/webapp/__init__.py
tests/resume_ai/__init__.py
tests/fixtures/test_config.yaml
  </files>
  <action>
Create the test directory tree with empty __init__.py files to make each directory a Python package (required for conftest.py fixture discovery in subdirectories).

**Directory structure to create:**
```
tests/
├── __init__.py              # Empty
├── platforms/
│   └── __init__.py          # Empty
├── webapp/
│   └── __init__.py          # Empty
├── resume_ai/
│   └── __init__.py          # Empty
└── fixtures/
    └── test_config.yaml     # Safe test defaults
```

All __init__.py files are empty (no content needed).

**test_config.yaml** -- must satisfy AppSettings validation (requires `search.queries` and `scoring.target_titles` + `scoring.tech_keywords`). All platforms disabled, zero delays, no real credentials:

```yaml
# Test configuration -- safe defaults for automated tests.
# No real credentials. All platforms disabled. Zero delays.

search:
  min_salary: 100000
  queries:
    - title: "test engineer"
      keywords: []
      max_pages: 1

scoring:
  target_titles:
    - "Senior Software Engineer"
    - "Principal Engineer"
  tech_keywords:
    - python
    - kubernetes
    - terraform
  weights:
    title_match: 2.0
    tech_overlap: 2.0
    remote: 1.0
    salary: 1.0

platforms:
  indeed:
    enabled: false
  dice:
    enabled: false
  remoteok:
    enabled: true

timing:
  nav_delay_min: 0.0
  nav_delay_max: 0.0
  form_delay_min: 0.0
  form_delay_max: 0.0
  page_load_timeout: 5000

apply:
  default_mode: semi_auto
  confirm_before_submit: true
  max_concurrent_applies: 1
  screenshot_before_submit: false
  headed_mode: false
  ats_form_fill_enabled: false
  ats_form_fill_timeout: 10
```

Verify the config is valid by loading it with AppSettings:
```bash
uv run python -c "
import os; os.environ['JOBFLOW_TEST_DB'] = '1'
from config import AppSettings
s = AppSettings(_yaml_file='tests/fixtures/test_config.yaml')
print(f'Config valid: {len(s.search.queries)} queries, {len(s.scoring.target_titles)} titles')
"
```

Note: The `_yaml_file` kwarg or adjusting `model_config['yaml_file']` may be needed. If AppSettings doesn't accept `_yaml_file`, instead temporarily set `AppSettings.model_config['yaml_file'] = 'tests/fixtures/test_config.yaml'` before instantiation, then reset it. The key is verifying the YAML parses without error.
  </action>
  <verify>
Run: `find tests -type f | sort` -- should show 5 __init__.py files and 1 YAML file.
Run: `uv run pytest --collect-only 2>&1 | tail -3` -- should show "no tests collected" (not import errors or missing directory errors).
  </verify>
  <done>tests/ directory structure exists with __init__.py in each sub-package. test_config.yaml is valid and satisfies AppSettings schema with safe defaults (all platforms disabled, zero delays, no real credentials).</done>
</task>

</tasks>

<verification>
1. `uv run pytest --collect-only` -- discovers tests/ directory, shows markers, no errors
2. `uv run python -c "import factory, faker, respx, pytest_socket, pytest_asyncio, pytest_cov"` -- all deps importable
3. `uv run pytest --markers | grep -E "unit|integration|e2e|slow"` -- all 4 markers registered
4. `ls tests/__init__.py tests/platforms/__init__.py tests/webapp/__init__.py tests/resume_ai/__init__.py` -- all exist
5. `cat tests/fixtures/test_config.yaml` -- valid YAML with safe defaults
</verification>

<success_criteria>
- pyproject.toml has 6 new dev dependencies (factory-boy, Faker, pytest-asyncio, respx, pytest-socket, pytest-cov) and they install successfully
- pytest configuration has testpaths, asyncio_mode=strict, 4 markers, addopts with --disable-socket and -m "not e2e" and --strict-markers
- coverage configuration has source list, omit list (excluding browser platform files), and report settings
- tests/ directory tree exists with __init__.py in root, platforms/, webapp/, resume_ai/
- tests/fixtures/test_config.yaml passes AppSettings validation with safe defaults
</success_criteria>

<output>
After completion, create `.planning/phases/09-test-infrastructure/09-01-SUMMARY.md`
</output>
