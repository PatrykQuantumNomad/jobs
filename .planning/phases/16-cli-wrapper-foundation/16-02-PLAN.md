---
phase: 16-cli-wrapper-foundation
plan: 02
type: execute
wave: 2
depends_on: ["16-01"]
files_modified:
  - resume_ai/tailor.py
  - resume_ai/cover_letter.py
  - webapp/app.py
  - pyproject.toml
  - tests/conftest.py
  - tests/resume_ai/conftest.py
  - tests/resume_ai/test_tailor.py
  - tests/resume_ai/test_cover_letter.py
  - tests/test_smoke.py
autonomous: true

must_haves:
  truths:
    - "resume_ai/tailor.py calls claude_cli.run() instead of anthropic.Anthropic().messages.parse()"
    - "resume_ai/cover_letter.py calls claude_cli.run() instead of anthropic.Anthropic().messages.parse()"
    - "tailor_resume() is now async and webapp/app.py awaits it directly (no asyncio.to_thread)"
    - "generate_cover_letter() is now async and webapp/app.py awaits it directly (no asyncio.to_thread)"
    - "The anthropic package is not imported by any production code at runtime"
    - "All existing resume_ai tests pass with updated subprocess mocks"
    - "The full test suite passes including smoke tests"
  artifacts:
    - path: "resume_ai/tailor.py"
      provides: "Async resume tailoring via claude_cli.run()"
      contains: "claude_cli"
    - path: "resume_ai/cover_letter.py"
      provides: "Async cover letter generation via claude_cli.run()"
      contains: "claude_cli"
    - path: "pyproject.toml"
      provides: "Dependencies without anthropic SDK"
    - path: "tests/conftest.py"
      provides: "Updated test infrastructure blocking CLI subprocess instead of SDK"
    - path: "tests/resume_ai/conftest.py"
      provides: "mock_claude_cli fixture replacing mock_anthropic"
  key_links:
    - from: "resume_ai/tailor.py"
      to: "claude_cli/client.py"
      via: "import and call claude_cli.run()"
      pattern: "await (claude_cli\\.)?run\\("
    - from: "resume_ai/cover_letter.py"
      to: "claude_cli/client.py"
      via: "import and call claude_cli.run()"
      pattern: "await (claude_cli\\.)?run\\("
    - from: "webapp/app.py"
      to: "resume_ai/tailor.py"
      via: "await tailor_resume() directly (no to_thread)"
      pattern: "await tailor_resume\\("
    - from: "webapp/app.py"
      to: "resume_ai/cover_letter.py"
      via: "await generate_cover_letter() directly (no to_thread)"
      pattern: "await generate_cover_letter\\("
    - from: "tests/conftest.py"
      to: "claude_cli"
      via: "_block_cli fixture patches asyncio.create_subprocess_exec"
      pattern: "create_subprocess_exec"
---

<objective>
Replace Anthropic SDK usage with claude_cli.run() in production code and update all test infrastructure to use subprocess mocks.

Purpose: This completes CFG-01 (SDK no longer required at runtime) and wires the claude_cli package built in Plan 01 into the actual resume/cover letter code paths. After this plan, the anthropic SDK is fully removed from runtime dependencies.

Output: Updated production files using claude_cli, updated tests with subprocess mocks, anthropic removed from pyproject.toml dependencies.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-cli-wrapper-foundation/16-RESEARCH.md
@.planning/phases/16-cli-wrapper-foundation/16-01-SUMMARY.md
@resume_ai/tailor.py
@resume_ai/cover_letter.py
@resume_ai/models.py
@webapp/app.py
@pyproject.toml
@tests/conftest.py
@tests/resume_ai/conftest.py
@tests/resume_ai/test_tailor.py
@tests/resume_ai/test_cover_letter.py
@tests/test_smoke.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Convert resume_ai to use claude_cli and update webapp call sites</name>
  <files>
    resume_ai/tailor.py
    resume_ai/cover_letter.py
    webapp/app.py
    pyproject.toml
  </files>
  <action>
**resume_ai/tailor.py** -- Replace Anthropic SDK with claude_cli:
- Remove `import anthropic`
- Add `from claude_cli import run as cli_run` and `from claude_cli.exceptions import CLIError`
- Change `def tailor_resume(...)` to `async def tailor_resume(...)` -- it now calls `await cli_run()`
- Keep `SYSTEM_PROMPT` unchanged (same anti-fabrication instructions)
- Change `DEFAULT_MODEL` from `"claude-sonnet-4-5-20250929"` to `"sonnet"` (CLI uses model aliases)
- Replace the entire try/except body with:
  ```python
  try:
      return await cli_run(
          system_prompt=SYSTEM_PROMPT,
          user_message=user_message,
          output_model=TailoredResume,
          model=model,
      )
  except CLIError as exc:
      raise RuntimeError(f"Resume tailoring failed: {exc}") from exc
  ```
- Keep `format_resume_as_text()` unchanged (pure function, no SDK dependency)
- The `user_message` construction stays the same
- Update docstring: "Resume tailoring via Claude CLI structured outputs" (not Anthropic)
- Update parameter docstring for `model`: "Claude CLI model alias. Defaults to 'sonnet'."

**resume_ai/cover_letter.py** -- Same pattern as tailor.py:
- Remove `import anthropic`
- Add `from claude_cli import run as cli_run` and `from claude_cli.exceptions import CLIError`
- Change `def generate_cover_letter(...)` to `async def generate_cover_letter(...)`
- Change `DEFAULT_MODEL` to `"sonnet"`
- Replace try/except body with `await cli_run(system_prompt=..., user_message=..., output_model=CoverLetter, model=model)`
- Wrap in `except CLIError as exc: raise RuntimeError(...)` for backward compat with webapp error handling
- Keep `format_cover_letter_as_text()` unchanged
- Update docstrings

**webapp/app.py** -- Update call sites (2 locations):
1. Line ~278 in `tailor_resume_endpoint`: Replace `tailored = await asyncio.to_thread(tailor_resume, ...)` with `tailored = await tailor_resume(resume_text=..., job_description=..., job_title=..., company_name=...)`. Remove the `asyncio.to_thread` wrapper since `tailor_resume` is now natively async.
2. Line ~368 in the cover letter endpoint: Replace `letter = await asyncio.to_thread(generate_cover_letter, ...)` with `letter = await generate_cover_letter(resume_text=..., job_description=..., job_title=..., company_name=...)`. Same pattern.
3. Both lazy imports inside the endpoints remain lazy -- just change the call from `asyncio.to_thread(func, ...)` to `await func(...)`.

**pyproject.toml** -- Remove SDK dependency:
- Remove line 19: `"anthropic>=0.79.0"` from the `dependencies` list
- Add `claude_cli` to `[tool.hatch.build.targets.wheel] packages` list (append to existing: `["platforms", "webapp", "resume_ai", "claude_cli"]`)
- Add `"claude_cli"` to `[tool.coverage.run] source` list so coverage tracks the new package

Do NOT remove anthropic from dev dependencies (it is not there). Do NOT change any other dependencies.
  </action>
  <verify>
    Run: `uv run ruff check resume_ai/tailor.py resume_ai/cover_letter.py webapp/app.py && uv run ruff format --check resume_ai/tailor.py resume_ai/cover_letter.py webapp/app.py`
    Both exit 0.
    Run: `python -c "import resume_ai.tailor; import resume_ai.cover_letter; print('no anthropic import')"` -- succeeds without anthropic installed (or at minimum, does not import anthropic at module level).
    Run: `grep -r "import anthropic" resume_ai/` -- returns no results (SDK fully removed from resume_ai).
  </verify>
  <done>
    resume_ai/tailor.py and resume_ai/cover_letter.py use claude_cli.run() instead of anthropic SDK. Both functions are async. webapp/app.py awaits them directly (no asyncio.to_thread). pyproject.toml no longer lists anthropic as a dependency. No production file imports anthropic.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update test infrastructure and resume_ai tests for subprocess mocks</name>
  <files>
    tests/conftest.py
    tests/resume_ai/conftest.py
    tests/resume_ai/test_tailor.py
    tests/resume_ai/test_cover_letter.py
    tests/test_smoke.py
  </files>
  <action>
**tests/conftest.py** -- Update global test infrastructure:
1. Remove line 22: `os.environ["ANTHROPIC_API_KEY"] = "test-key-not-real"` -- no longer needed
2. Replace `_block_anthropic` fixture (lines 84-105) with `_block_cli` fixture:
   ```python
   @pytest.fixture(autouse=True)
   def _block_cli(monkeypatch):
       """Prevent accidental real Claude CLI calls during tests.

       Patches asyncio.create_subprocess_exec to raise RuntimeError.
       Tests that need to simulate CLI responses should use the mock_claude_cli
       fixture from tests/resume_ai/conftest.py or tests/claude_cli/conftest.py.
       """
       async def _blocked(*args, **kwargs):
           raise RuntimeError(
               "Test attempted real Claude CLI subprocess call "
               "-- use the mock_claude_cli fixture instead"
           )
       monkeypatch.setattr("asyncio.create_subprocess_exec", _blocked)
   ```
3. Remove the `try: import anthropic.resources.messages` block entirely
4. Keep all other fixtures unchanged (_reset_settings, _fresh_db, db_with_jobs)
5. Update module docstring to reference Claude CLI instead of Anthropic SDK

**tests/resume_ai/conftest.py** -- Replace mock_anthropic with mock_claude_cli:
- Remove entire `mock_anthropic` fixture
- Create `mock_claude_cli` fixture:
  ```python
  @pytest.fixture
  def mock_claude_cli(monkeypatch):
      """Provide a mock Claude CLI subprocess that returns controlled responses.

      Overrides the autouse _block_cli guard. Returns a helper object with
      a set_response() method to configure what the mock CLI returns.

      Usage in tests::
          def test_tailor(mock_claude_cli):
              mock_claude_cli.set_response(expected_model)
      """
  ```
  - The fixture patches `asyncio.create_subprocess_exec` with an AsyncMock
  - `set_response(model_instance)` serializes the model via `model_instance.model_dump(mode="json")` and wraps it in a CLI envelope: `{"type": "result", "subtype": "success", "is_error": false, "result": "", "structured_output": <data>, "duration_ms": 1000, "num_turns": 2}`
  - The mock process returns `stdout=json.dumps(envelope).encode()`, `stderr=b""`, `returncode=0`
  - `set_error(returncode, stderr_text)` configures the mock to simulate CLI failure
  - Patch `shutil.which` to return `"/usr/local/bin/claude"` so `CLINotFoundError` is not raised

**tests/resume_ai/test_tailor.py** -- Rewrite tests for async + CLI mocks:
- All test methods become `async def` with `@pytest.mark.asyncio` decorator
- Replace `mock_anthropic` fixture with `mock_claude_cli` fixture
- `test_tailor_resume_success`: set mock_claude_cli response to `_make_tailored_resume()`, call `await tailor_resume(...)`, assert result matches. Verify fields populated correctly.
- `test_tailor_resume_cli_error`: configure mock_claude_cli to return non-zero exit -> assert `RuntimeError` raised with "Resume tailoring failed"
- `test_tailor_resume_cli_not_found`: patch `shutil.which` to return None -> assert `RuntimeError` raised
- Remove old tests for `anthropic.AuthenticationError` and `anthropic.APIError` (SDK no longer used)
- Keep `TestFormatResumeAsText` class unchanged (pure function, no async, no mocks needed)
- Keep the `_make_tailored_resume()` helper unchanged

**tests/resume_ai/test_cover_letter.py** -- Same pattern as test_tailor.py:
- All test methods become `async def` with `@pytest.mark.asyncio`
- Replace `mock_anthropic` with `mock_claude_cli`
- `test_generate_cover_letter_success`: set response to `_make_cover_letter()`, call `await generate_cover_letter(...)`, assert result matches
- `test_generate_cover_letter_cli_error`: CLI failure -> `RuntimeError`
- Remove old SDK-specific tests
- Keep `TestFormatCoverLetterAsText` unchanged

**tests/test_smoke.py** -- Update infrastructure smoke tests:
- Replace `TestAnthropicGuard` class with `TestCLIGuard`:
  ```python
  class TestCLIGuard:
      """Verify Claude CLI subprocess calls are blocked."""

      @pytest.mark.asyncio
      async def test_cli_blocked(self):
          import asyncio
          with pytest.raises(RuntimeError, match="real Claude CLI subprocess call"):
              await asyncio.create_subprocess_exec("claude", "-p", "test")
  ```
- Replace `test_anthropic_key_is_fake` in `TestEnvironment` with `test_anthropic_key_not_set`:
  ```python
  def test_anthropic_key_not_required(self):
      # ANTHROPIC_API_KEY is no longer set in test env
      # This confirms the SDK dependency is removed
      assert "ANTHROPIC_API_KEY" not in os.environ or True  # May still exist from user env
  ```
  Actually simpler: just remove `test_anthropic_key_is_fake` entirely since we no longer set it. Replace with:
  ```python
  def test_no_anthropic_sdk_in_production(self):
      """Verify no production module imports anthropic at module level."""
      import importlib
      import sys
      # Remove anthropic from sys.modules if cached
      mods_before = set(sys.modules.keys())
      importlib.import_module("resume_ai.tailor")
      importlib.import_module("resume_ai.cover_letter")
      # anthropic should not have been imported
      new_mods = set(sys.modules.keys()) - mods_before
      assert not any("anthropic" in m for m in new_mods), (
          f"Production code imported anthropic: {[m for m in new_mods if 'anthropic' in m]}"
      )
  ```
  Note: This test may need adjustment if anthropic is still installed as a package but just not imported. The key assertion is that importing resume_ai modules does NOT trigger an anthropic import.
  </action>
  <verify>
    Run: `uv run pytest tests/test_smoke.py tests/resume_ai/ -v --no-header`
    All tests pass.
    Run: `uv run pytest tests/ -v --no-header`
    Full test suite passes (all 428+ tests, plus new claude_cli tests).
    Run: `uv run ruff check tests/conftest.py tests/resume_ai/ tests/test_smoke.py && uv run ruff format --check tests/conftest.py tests/resume_ai/ tests/test_smoke.py`
    Both exit 0.
  </verify>
  <done>
    Test infrastructure updated: _block_anthropic replaced with _block_cli, mock_anthropic replaced with mock_claude_cli. All resume_ai tests pass with async + subprocess mocks. Smoke tests verify CLI guard and no-SDK-import. Full test suite passes with no regressions.
  </done>
</task>

</tasks>

<verification>
1. `grep -r "import anthropic" resume_ai/ webapp/ orchestrator.py scorer.py config.py models.py` -- returns ZERO results (SDK fully removed from production)
2. `uv run pytest tests/ -v --no-header` -- full test suite passes
3. `uv run ruff check .` -- no lint errors
4. `grep "anthropic" pyproject.toml` -- not in dependencies list (may appear in comments)
5. `python -c "from resume_ai.tailor import tailor_resume; import inspect; assert inspect.iscoroutinefunction(tailor_resume)"` -- confirms async
6. `python -c "from resume_ai.cover_letter import generate_cover_letter; import inspect; assert inspect.iscoroutinefunction(generate_cover_letter)"` -- confirms async
</verification>

<success_criteria>
- Zero production files import anthropic
- anthropic removed from pyproject.toml dependencies
- tailor_resume() and generate_cover_letter() are async, use claude_cli.run()
- webapp/app.py awaits them directly (no asyncio.to_thread)
- _block_cli replaces _block_anthropic in test conftest
- mock_claude_cli replaces mock_anthropic
- All existing + new tests pass
- Full test suite has no regressions
</success_criteria>

<output>
After completion, create `.planning/phases/16-cli-wrapper-foundation/16-02-SUMMARY.md`
</output>
