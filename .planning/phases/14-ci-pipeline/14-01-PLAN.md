---
phase: 14-ci-pipeline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pyproject.toml
  - .github/workflows/ci.yml
autonomous: true

must_haves:
  truths:
    - "Pushing to main or opening a PR triggers a GitHub Actions workflow that runs tests, coverage, and linting"
    - "Coverage report is generated and the workflow fails if coverage drops below the configured threshold"
    - "Ruff linting runs alongside tests and blocks merge on lint errors"
    - "Python dependencies are cached between CI runs via uv built-in caching"
    - "E2E tests run as a separate optional job that does not block the main test/lint workflow"
  artifacts:
    - path: ".github/workflows/ci.yml"
      provides: "GitHub Actions CI workflow with test-lint and e2e jobs"
      contains: "astral-sh/setup-uv@v7"
    - path: "pyproject.toml"
      provides: "Coverage threshold enforcement"
      contains: "fail_under"
  key_links:
    - from: ".github/workflows/ci.yml"
      to: "pyproject.toml"
      via: "uv run pytest --cov reads [tool.coverage.report] fail_under"
      pattern: "uv run pytest.*--cov"
    - from: ".github/workflows/ci.yml"
      to: "pyproject.toml"
      via: "astral-sh/ruff-action reads [tool.ruff] config"
      pattern: "astral-sh/ruff-action"
---

<objective>
Create the GitHub Actions CI pipeline with a required test-lint job and an optional E2E job, plus configure coverage threshold enforcement in pyproject.toml.

Purpose: Automate test/lint/coverage on every push and PR so regressions are caught immediately. This satisfies all five CI requirements (CI-01 through CI-05).
Output: `.github/workflows/ci.yml` workflow file and updated `pyproject.toml` with `fail_under` threshold.
</objective>

<execution_context>
@/Users/patrykattc/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patrykattc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-ci-pipeline/14-RESEARCH.md
@pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add coverage threshold to pyproject.toml</name>
  <files>pyproject.toml</files>
  <action>
Add `fail_under = 80` to the existing `[tool.coverage.report]` section in pyproject.toml. Place it after the `skip_empty = true` line.

The existing section looks like:
```toml
[tool.coverage.report]
show_missing = true
skip_empty = true
exclude_lines = [...]
```

Add the single line so it becomes:
```toml
[tool.coverage.report]
show_missing = true
skip_empty = true
fail_under = 80
exclude_lines = [...]
```

This ensures both local `pytest --cov` and CI enforce the same 80% threshold. No CLI flag duplication needed.

NOTE: Current coverage is ~63%. The requirement specifies 80%. Setting this now means CI will correctly fail until coverage reaches 80%, which is intentional -- it signals that more tests are needed. If this causes immediate CI failures after merge, the threshold can be lowered temporarily, but the plan follows the requirement as specified.

After editing, verify the file is valid TOML by running:
```bash
uv run python -c "import tomllib; tomllib.load(open('pyproject.toml', 'rb'))"
```
  </action>
  <verify>
Run `uv run python -c "import tomllib; d = tomllib.load(open('pyproject.toml', 'rb')); print(d['tool']['coverage']['report']['fail_under'])"` and confirm it prints `80`.
  </verify>
  <done>pyproject.toml has `fail_under = 80` in `[tool.coverage.report]` and parses without error.</done>
</task>

<task type="auto">
  <name>Task 2: Create GitHub Actions CI workflow</name>
  <files>.github/workflows/ci.yml</files>
  <action>
Create `.github/workflows/ci.yml` with a single workflow containing two jobs.

**Workflow-level config:**
- `name: CI`
- Triggers: `push` to `main` branch, `pull_request` targeting `main` branch
- Concurrency group: `${{ github.workflow }}-${{ github.ref }}` with `cancel-in-progress: true`

**Job 1: `test-lint` (required)**
- `runs-on: ubuntu-latest`
- `timeout-minutes: 10`
- Steps (in order):
  1. `actions/checkout@v6`
  2. `astral-sh/setup-uv@v7` with `enable-cache: true` (handles Python installation from `.python-version`, caches uv dependencies using `uv.lock` hash)
  3. Install system dependencies for WeasyPrint: `sudo apt-get update && sudo apt-get install -y libpango-1.0-0 libpangoft2-1.0-0 libharfbuzz-subset0`
  4. Install Python and project dependencies: `uv sync --locked --dev` (uses `--locked` to fail if `uv.lock` is stale)
  5. Lint with ruff: `astral-sh/ruff-action@v3` (zero-config, reads `[tool.ruff]` from pyproject.toml, provides GitHub PR annotations)
  6. Run tests with coverage: `uv run pytest --cov --cov-report=term-missing --cov-report=xml` (fail_under comes from pyproject.toml, NOT as a CLI flag)
  7. Upload coverage artifact: `actions/upload-artifact@v5` with `name: coverage-report`, `path: coverage.xml`, `retention-days: 14`, `if: always()`

**Job 2: `e2e` (optional, non-blocking)**
- `runs-on: ubuntu-latest`
- `timeout-minutes: 15`
- `continue-on-error: true` (CI-05: does not block PR merges)
- `needs: test-lint` (only runs if test-lint passes)
- Steps (in order):
  1. `actions/checkout@v6`
  2. `astral-sh/setup-uv@v7` with `enable-cache: true`
  3. Install system dependencies for WeasyPrint: same apt-get command as above
  4. Install Python and project dependencies: `uv sync --locked --dev`
  5. Install Playwright browsers: `uv run playwright install --with-deps chromium` (do NOT cache Playwright browsers -- Playwright docs recommend against it, restore time equals download time)
  6. Run E2E tests: `uv run pytest -m e2e --tracing=retain-on-failure || true` (the `|| true` handles exit code 5 when no e2e tests exist yet; Phase 15 will add them)
  7. Upload Playwright traces: `actions/upload-artifact@v5` with `name: playwright-traces`, `path: test-results/`, `retention-days: 7`, `if: always()`

**Important details:**
- Do NOT use `actions/setup-python` -- `astral-sh/setup-uv@v7` reads `.python-version` (which contains `3.14`) and installs Python via `uv python install`
- Do NOT use `actions/cache` for dependencies -- `setup-uv` built-in caching handles this via `uv.lock` hash
- Do NOT add `--cov-fail-under` to the pytest command -- the threshold is in `pyproject.toml`
- The `|| true` after the e2e pytest command prevents exit code 5 (no tests collected) from failing the step. Combined with `continue-on-error: true` on the job, this ensures the e2e job never blocks anything.

After creating the file, verify YAML syntax:
```bash
uv run python -c "import yaml; yaml.safe_load(open('.github/workflows/ci.yml'))" 2>/dev/null || uv run python -c "
import json, re
with open('.github/workflows/ci.yml') as f:
    content = f.read()
# Basic structure checks
assert 'name: CI' in content
assert 'test-lint:' in content
assert 'e2e:' in content
assert 'continue-on-error: true' in content
assert 'astral-sh/setup-uv@v7' in content
assert 'astral-sh/ruff-action@v3' in content
assert 'fail_under' not in content  # threshold is in pyproject.toml, NOT in workflow
print('CI workflow structure validated')
"
```
  </action>
  <verify>
1. File `.github/workflows/ci.yml` exists
2. Contains two jobs: `test-lint` and `e2e`
3. `test-lint` job has: checkout, setup-uv, apt-get for WeasyPrint, uv sync --locked, ruff-action, pytest --cov, upload-artifact
4. `e2e` job has: `continue-on-error: true`, `needs: test-lint`, playwright install, pytest -m e2e, upload traces
5. Concurrency group configured to cancel in-progress runs
6. No `actions/setup-python` present (handled by setup-uv)
7. No `--cov-fail-under` flag (handled by pyproject.toml)
  </verify>
  <done>
`.github/workflows/ci.yml` exists with a required `test-lint` job (tests + coverage + ruff) and an optional `e2e` job (Playwright, non-blocking). Pushing to main or opening a PR will trigger both jobs. The workflow uses `astral-sh/setup-uv@v7` for dependency caching and Python management, and `astral-sh/ruff-action@v3` for linting.
  </done>
</task>

</tasks>

<verification>
1. `pyproject.toml` parses correctly and contains `fail_under = 80`
2. `.github/workflows/ci.yml` exists and has valid structure
3. CI triggers on push to main and pull_request to main
4. `test-lint` job installs deps via uv, runs ruff, runs pytest with coverage
5. `e2e` job installs Playwright, runs e2e tests, does not block PR merges
6. No redundant tools (no setup-python, no actions/cache, no CLI fail-under flag)
</verification>

<success_criteria>
All five CI requirements satisfied:
- CI-01: Workflow triggers on push to main and on PR (on.push.branches + on.pull_request.branches)
- CI-02: Coverage report generated with `--cov-report=xml` and threshold enforced via `fail_under = 80`
- CI-03: Ruff linting runs via `astral-sh/ruff-action@v3` in the test-lint job
- CI-04: Dependencies cached via `astral-sh/setup-uv@v7` `enable-cache: true` (Playwright NOT cached per official recommendation)
- CI-05: E2E job has `continue-on-error: true` and is separate from test-lint
</success_criteria>

<output>
After completion, create `.planning/phases/14-ci-pipeline/14-01-SUMMARY.md`
</output>
