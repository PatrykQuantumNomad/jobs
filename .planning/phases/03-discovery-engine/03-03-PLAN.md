---
phase: 03-discovery-engine
plan: 03
type: execute
wave: 3
depends_on: ["03-02"]
files_modified:
  - webapp/app.py
  - webapp/templates/dashboard.html
  - webapp/templates/job_detail.html
autonomous: false

must_haves:
  truths:
    - "Newly discovered jobs show a 'NEW' badge on the dashboard job card"
    - "Clicking into a job detail marks it as viewed, removing the NEW badge on next dashboard load"
    - "Each job card shows inline score breakdown: 'Title +2 | Tech +2 | Remote +1 | Salary 0 = 5'"
    - "Salary displays in compact format '$150K-$180K USD/yr' instead of raw numbers"
    - "Jobs with no salary data show no salary field at all (not 'N/A' or 'Not listed')"
    - "Job detail page shows company aliases when present: 'Also posted as: Google LLC'"
    - "Job detail page shows score breakdown with matched tech keywords"
  artifacts:
    - path: "webapp/app.py"
      provides: "Mark-viewed on detail access, stale removal on import"
      contains: "mark_viewed"
    - path: "webapp/templates/dashboard.html"
      provides: "NEW badge, inline score breakdown, salary_display"
      contains: "NEW"
    - path: "webapp/templates/job_detail.html"
      provides: "Score breakdown section, company aliases, salary_display"
      contains: "score_breakdown"
  key_links:
    - from: "webapp/app.py"
      to: "webapp/db.py"
      via: "Calls db.mark_viewed on job detail access"
      pattern: "db\\.mark_viewed"
    - from: "webapp/templates/dashboard.html"
      to: "webapp/db.py"
      via: "Reads job.viewed_at to conditionally show NEW badge"
      pattern: "viewed_at"
    - from: "webapp/templates/dashboard.html"
      to: "webapp/db.py"
      via: "Reads job.score_breakdown for inline display"
      pattern: "score_breakdown"
---

<objective>
Update the web dashboard to display all Phase 3 improvements: NEW badges for fresh jobs, inline score breakdowns on job cards, normalized salary display, and company alias merge trail.

Purpose: This makes the Phase 3 data processing improvements visible to the user through the dashboard, completing the full loop from discovery to display.
Output: Updated `webapp/app.py` with mark-viewed logic, updated dashboard and detail templates with new UI elements.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-discovery-engine/03-RESEARCH.md
@.planning/phases/03-discovery-engine/03-CONTEXT.md
@.planning/phases/03-discovery-engine/03-01-SUMMARY.md
@.planning/phases/03-discovery-engine/03-02-SUMMARY.md

@webapp/app.py
@webapp/db.py
@webapp/templates/dashboard.html
@webapp/templates/job_detail.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update webapp/app.py with mark-viewed and import enhancements</name>
  <files>webapp/app.py</files>
  <action>
Modify `webapp/app.py`:

**Mark viewed on job detail access:**
In the `job_detail` route handler, after fetching the job and before returning the template response:
- If `job.get("viewed_at") is None`, call `db.mark_viewed(dedup_key)`.
- This removes the NEW badge when the user clicks into a job detail, per user decision: "Badge disappears when the user views (clicks into) the job detail."

**Add score_breakdown parsing to template context:**
- The `score_breakdown` column stores JSON. Add a Jinja2 filter or parse it in the route before passing to template.
- For dashboard: parse each job's `score_breakdown` from JSON string to dict so the template can render inline breakdown.
- For job_detail: same parsing, plus check for `company_aliases` JSON.

Actually, the dashboard already has a `parse_json` filter registered: `templates.env.filters["parse_json"] = lambda s: json.loads(s) if isinstance(s, str) else s`. This can be used in templates directly. No additional parsing needed in routes.

**Update import_jobs route:**
After importing jobs, the import route should trigger stale job removal for completeness. However, stale removal is primarily done by the orchestrator after pipeline runs. The import route is for manual JSON import. Leave import_jobs as-is -- stale removal happens in the orchestrator, not the web UI.

No other changes to app.py besides the mark_viewed call in job_detail.
  </action>
  <verify>
Run: `python -c "
# Verify mark_viewed is called in job_detail handler
import inspect
from webapp.app import job_detail
source = inspect.getsource(job_detail)
assert 'mark_viewed' in source, 'mark_viewed not found in job_detail handler'
print('mark_viewed wired in job_detail: OK')
"
`
  </verify>
  <done>job_detail route calls db.mark_viewed(dedup_key) when viewed_at is None, removing the NEW badge on subsequent dashboard views.</done>
</task>

<task type="auto">
  <name>Task 2: Update dashboard and detail templates with NEW badge, score breakdown, salary display, and aliases</name>
  <files>webapp/templates/dashboard.html, webapp/templates/job_detail.html</files>
  <action>
**dashboard.html changes:**

1. **NEW badge** on job cards: In the Score column (`<td>` with score display), after the score span, add:
   ```html
   {% if not job.viewed_at %}
   <span class="ml-1 text-xs px-1.5 py-0.5 rounded bg-green-100 text-green-800 font-semibold">NEW</span>
   {% endif %}
   ```
   Per user decision: "NEW badge on job cards for newly discovered jobs."

2. **Inline score breakdown**: Add a new row or sub-line under each job row showing the breakdown. Two approaches:
   - Option A: Add breakdown text in the Score column below the score number
   - Option B: Add a small text line spanning the row

   Best approach: Show breakdown as a small text below the score badge in the Score column:
   ```html
   <td class="px-4 py-3">
       {% if job.score %}
       <span class="score-{{ job.score }}">{{ job.score }}</span>
       {% if not job.viewed_at %}
       <span class="ml-1 text-xs px-1.5 py-0.5 rounded bg-green-100 text-green-800 font-semibold">NEW</span>
       {% endif %}
       {% if job.score_breakdown %}
       {% set bd = job.score_breakdown | parse_json %}
       <div class="text-xs text-gray-400 mt-0.5 whitespace-nowrap">
           Title +{{ bd.title }} | Tech +{{ bd.tech }} | Remote +{{ bd.remote }} | Salary +{{ bd.salary }}
       </div>
       {% endif %}
       {% else %}
       <span class="text-gray-300">&mdash;</span>
       {% endif %}
   </td>
   ```
   Per user decision: "Inline breakdown on the job card: 'Title +2 | Tech +2 | Remote +1 | Salary 0 = 5'" -- the total is already shown by the score badge, so the breakdown shows factors only.

3. **Salary display**: Replace the salary column content. Instead of showing raw `job.salary` or formatted `salary_min`/`salary_max`, use `job.salary_display`:
   ```html
   <td class="px-4 py-3 text-gray-500 hidden lg:table-cell">
       {% if job.salary_display %}
           {{ job.salary_display }}
       {% endif %}
   </td>
   ```
   Per user decision: "Jobs with no salary data: don't show a salary field at all (blank/hidden, not 'Not listed')." So when salary_display is empty, show nothing (no dash, no "N/A").

**job_detail.html changes:**

1. **Score breakdown section**: In the header area (after the score display), add a breakdown line:
   ```html
   {% if job.score_breakdown %}
   {% set bd = job.score_breakdown | parse_json %}
   <div class="text-sm text-gray-500 mt-2">
       Title +{{ bd.title }} |
       Tech +{{ bd.tech }}{% if bd.tech_matched %} ({{ bd.tech_matched[:5] | join(', ') }}){% endif %} |
       Remote +{{ bd.remote }} |
       Salary +{{ bd.salary }} = {{ bd.total }}
   </div>
   {% endif %}
   ```
   Claude's discretion decision: Show matched tech keywords alongside the tech score in the detail view (e.g., "Tech +2 (Kubernetes, Python)"). This provides useful transparency on the detail page without cluttering the dashboard cards.

2. **Company aliases**: In the sidebar, below the company name or in the metadata section, show merge trail:
   ```html
   {% if job.company_aliases %}
   {% set aliases = job.company_aliases | parse_json %}
   {% if aliases %}
   <p class="text-sm text-gray-500 mt-1">Also posted as: {{ aliases | join(', ') }}</p>
   {% endif %}
   {% endif %}
   ```
   Per user decision: "Show merge trail in dashboard: 'Also posted as: Google LLC, Alphabet Inc.'"

3. **Salary display**: Replace the salary badge in the header area. Use `salary_display` instead of raw salary:
   ```html
   {% if job.salary_display %}
   <span class="text-sm bg-green-50 text-green-700 px-3 py-1 rounded-full">{{ job.salary_display }}</span>
   {% endif %}
   ```
   Per user decision: "Jobs with no salary data: don't show a salary field at all." Remove the fallback to `salary_min`/`salary_max` formatting.

4. **Metadata section**: Add `first_seen_at` and `viewed_at` to the metadata block at the bottom of the sidebar for transparency.
  </action>
  <verify>
Start the web server and visually inspect:
1. Run: `cd /Users/patrykattc/work/jobs && python -m webapp.app &`
2. Open http://127.0.0.1:8000 -- check dashboard for:
   - NEW badges on jobs where viewed_at is NULL
   - Inline score breakdowns below score numbers
   - Salary in compact format ($XK-$YK USD/yr)
   - No salary shown for jobs without salary data (no dash, no N/A)
3. Click a job -- check detail page for:
   - Score breakdown with matched keywords
   - Company aliases (if any)
   - Salary in compact format
4. Go back to dashboard -- the clicked job should no longer show NEW badge
5. Kill server: `pkill -f "uvicorn webapp.app"`

Also verify templates have no syntax errors:
Run: `python -c "from jinja2 import Environment, FileSystemLoader; env = Environment(loader=FileSystemLoader('/Users/patrykattc/work/jobs/webapp/templates')); env.get_template('dashboard.html'); env.get_template('job_detail.html'); print('Templates parse OK')"`
  </verify>
  <done>Dashboard shows NEW badges, inline score breakdowns, and compact salary display. Job detail shows breakdown with matched keywords, company aliases, and compact salary. No salary shown for jobs without salary data. Templates render without errors.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Phase 3 Discovery Engine: salary normalization, fuzzy deduplication, score breakdowns, delta detection (NEW badges), and all dashboard UI updates.</what-built>
  <how-to-verify>
1. Start the web dashboard: `cd /Users/patrykattc/work/jobs && python -m webapp.app`
2. Open http://127.0.0.1:8000
3. Import some pipeline data if needed (click "Import Pipeline Results")

**Check dashboard:**
- Jobs with salary data show compact format like "$150K-$200K USD/yr"
- Jobs without salary show nothing in the salary column (no dash, no "Not listed")
- Score column shows inline breakdown: "Title +N | Tech +N | Remote +N | Salary +N"
- Newly imported jobs show green "NEW" badge

**Check job detail (click any job):**
- Score breakdown visible with matched tech keywords (e.g., "Tech +2 (Kubernetes, Python)")
- If job has company aliases, shows "Also posted as: ..." below company name
- Salary in compact format
- Go back to dashboard -- the job you clicked should no longer show "NEW" badge

**If running a full pipeline test:**
- `python orchestrator.py --platforms remoteok` (low-risk, no auth needed)
- Check that jobs are scored with breakdowns
- Run again -- previously seen jobs should NOT have NEW badge
- Jobs that disappeared should be removed

4. Stop server: Ctrl+C
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. Templates parse without Jinja2 syntax errors
2. Dashboard shows NEW badge only for unviewed jobs (viewed_at IS NULL)
3. Clicking job detail sets viewed_at, removing NEW badge
4. Score breakdown renders inline on dashboard cards
5. Score breakdown with keywords renders on detail page
6. Salary uses compact format, empty when no data
7. Company aliases shown on detail page when present
8. Human verification confirms visual correctness
</verification>

<success_criteria>
- NEW badge appears on newly discovered jobs, disappears after clicking into detail
- Inline score breakdown matches format: "Title +N | Tech +N | Remote +N | Salary +N"
- Detail page shows tech keywords in breakdown: "Tech +2 (Kubernetes, Python)"
- Salary displays as "$150K-$180K USD/yr" on both dashboard and detail
- No salary field shown when salary data is missing (no dash, no placeholder)
- Company aliases shown as "Also posted as: ..." when present
- All templates render without errors
- Human approves visual appearance
</success_criteria>

<output>
After completion, create `.planning/phases/03-discovery-engine/03-03-SUMMARY.md`
</output>
