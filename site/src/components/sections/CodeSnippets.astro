---
import { Code } from "astro:components";

const THEME = "one-dark-pro";

const snippets = [
  {
    id: "protocol",
    tab: "Protocol",
    title: "Platform Protocol",
    filename: "platforms/protocols.py",
    description:
      "Runtime-checkable Protocol defines the contract every platform adapter must implement.",
    lang: "python" as const,
    code: `@runtime_checkable
class BrowserPlatform(Protocol):
    """Contract for browser-automated job platforms."""

    platform_name: str

    def init(self, context: BrowserContext) -> None: ...
    def login(self) -> bool: ...
    def is_logged_in(self) -> bool: ...
    def search(self, query: SearchQuery) -> list[Job]: ...
    def get_job_details(self, job: Job) -> Job: ...
    def apply(self, job: Job, resume_path: Path | None = None) -> bool: ...`,
  },
  {
    id: "scoring",
    tab: "Scoring",
    title: "Scoring Engine",
    filename: "scorer.py",
    description:
      "Weighted multi-factor scoring rates each job 1\u20135 against the candidate profile.",
    lang: "python" as const,
    code: `class JobScorer:
    """Score jobs 1-5 against candidate profile."""

    def _compute(self, job: Job) -> tuple[int, ScoreBreakdown]:
        w = self.weights

        title_pts = self._title_score(job.title)
        tech_pts, tech_matched = self._tech_score_with_keywords(job)
        remote_pts = self._location_score(job.location)
        salary_pts = self._salary_score(job)

        raw = (
            title_pts * w.title_match / 2.0
            + tech_pts * w.tech_overlap / 2.0
            + remote_pts * w.remote
            + salary_pts * w.salary
        )

        total = 5 if raw >= 5 else 4 if raw >= 4 else ...

        return total, ScoreBreakdown(
            title_points=title_pts, tech_points=tech_pts,
            tech_matched=tech_matched, remote_points=remote_pts,
            salary_points=salary_pts, total=total,
        )`,
  },
  {
    id: "pipeline",
    tab: "Pipeline",
    title: "Orchestrator",
    filename: "orchestrator.py",
    description:
      "Five-phase pipeline with error recovery, credential validation, and run history tracking.",
    lang: "python" as const,
    code: `def run(self, platforms: list[str] | None = None) -> None:
    """Execute the five-phase pipeline."""
    if platforms is None:
        platforms = self.settings.enabled_platforms()
    for name in platforms:
        get_platform(name)  # Validates registration

    try:
        self.phase_0_setup()
        self.phase_1_login(platforms)
        self.phase_2_search(platforms)
        self.phase_3_score()
        self.phase_4_apply()  # Human-in-the-loop
    finally:
        webdb.record_run(
            status="success" if not self._run_errors else "partial",
            total_raw=self._total_raw,
            total_scored=len(self.discovered_jobs),
        )`,
  },
  {
    id: "resume",
    tab: "Resume AI",
    title: "Anti-Fabrication Guardrails",
    filename: "resume_ai/tailor.py",
    description:
      "Claude CLI with strict rules preventing the AI from inventing experience or qualifications.",
    lang: "python" as const,
    code: `SYSTEM_PROMPT = """\\
ABSOLUTE RULES \u2014 VIOLATION IS UNACCEPTABLE:
1. MUST NOT add skills, technologies, or achievements
   not already in the original resume.
2. MUST NOT invent certifications, awards, or credentials.
3. MUST NOT change dates, company names, or job titles.
4. MUST NOT fabricate quantified results or metrics.
"""

async def tailor_resume(
    resume_text: str, job_description: str,
    job_title: str, company_name: str,
) -> TailoredResume:
    """Structured output with Pydantic schema validation."""
    return await cli_run(
        system_prompt=SYSTEM_PROMPT,
        user_message=build_prompt(resume_text, job_title, company_name),
        output_model=TailoredResume,
        model="sonnet",
    )`,
  },
  {
    id: "apply",
    tab: "Apply",
    title: "SSE Apply Engine",
    filename: "apply_engine/engine.py",
    description:
      "Thread-safe event bridge from Playwright to FastAPI with human confirmation gates.",
    lang: "python" as const,
    code: `async def apply(self, job: dict, mode: str, queue: asyncio.Queue):
    """Serialize applies, stream events via SSE."""
    async with self._semaphore:
        loop = asyncio.get_running_loop()
        emit = self._make_emitter(queue, loop)
        await asyncio.to_thread(self._apply_sync, job, mode, emit)

def _make_emitter(self, queue, loop):
    """Bridge sync Playwright thread -> async FastAPI."""
    def emit(event: ApplyEvent) -> None:
        loop.call_soon_threadsafe(queue.put_nowait, event.model_dump())
    return emit

# Confirmation gate in _apply_sync:
if config.confirm_before_submit:
    emit(ApplyEvent(type=ApplyEventType.AWAITING_CONFIRM))
    confirmed = self._confirmations[key].wait(timeout=300)
    if not confirmed:
        return  # User declined in dashboard`,
  },
];
---

<section id="code" data-animate class="py-20 bg-surface-900">
  <div class="max-w-4xl mx-auto px-4">
    <h2 class="font-display text-3xl font-bold text-white text-center">
      Under the Hood
    </h2>
    <p class="mt-3 text-surface-400 text-center max-w-2xl mx-auto">
      Real code from the project &mdash; protocol-driven architecture with pluggable platforms
    </p>

    <!-- Tab buttons -->
    <div class="mt-10 flex flex-wrap justify-center gap-2" id="code-tabs">
      {snippets.map((snippet, i) => (
        <button
          data-code-tab={snippet.id}
          class:list={[
            "px-4 py-2 rounded-lg text-sm font-semibold transition-all duration-200",
            i === 0
              ? "bg-primary-600 text-white shadow-md"
              : "text-surface-400 hover:text-white hover:bg-surface-800",
          ]}
        >
          {snippet.tab}
        </button>
      ))}
    </div>

    <!-- Tab panels -->
    <div class="mt-6 relative">
      {snippets.map((snippet, i) => (
        <div
          data-code-panel={snippet.id}
          class:list={[
            "rounded-xl overflow-hidden border border-surface-700/50",
            "shadow-[0_0_20px_oklch(0.52_0.175_155_/_0.08)]",
            "transition-opacity duration-300",
            i === 0 ? "opacity-100 relative" : "opacity-0 absolute inset-0 pointer-events-none",
          ]}
        >
          <div class="bg-surface-800/80 px-6 py-4 flex items-start justify-between">
            <div>
              <h3 class="font-display font-semibold text-white">
                {snippet.title}
              </h3>
              <p class="mt-1 text-sm text-surface-400">
                {snippet.description}
              </p>
            </div>
            <span class="shrink-0 ml-4 bg-accent-900/30 text-accent-300 font-mono text-xs px-2 py-1 rounded">
              {snippet.filename}
            </span>
          </div>
          <div class="overflow-x-auto">
            <Code code={snippet.code} lang={snippet.lang} theme={THEME} />
          </div>
        </div>
      ))}
    </div>
  </div>
</section>

<script>
  function initCodeTabs() {
    const container = document.getElementById('code-tabs');
    if (!container) return;

    const section = container.closest('section');
    if (!section) return;

    const buttons = section.querySelectorAll<HTMLElement>('[data-code-tab]');
    const panels = section.querySelectorAll<HTMLElement>('[data-code-panel]');

    buttons.forEach(btn => {
      btn.addEventListener('click', () => {
        const tab = btn.dataset.codeTab;

        buttons.forEach(b => {
          const isActive = b.dataset.codeTab === tab;
          b.classList.toggle('bg-primary-600', isActive);
          b.classList.toggle('text-white', isActive);
          b.classList.toggle('shadow-md', isActive);
          b.classList.toggle('text-surface-400', !isActive);
          b.classList.toggle('hover:text-white', !isActive);
          b.classList.toggle('hover:bg-surface-800', !isActive);
        });

        panels.forEach(p => {
          const isActive = p.dataset.codePanel === tab;
          p.classList.toggle('opacity-100', isActive);
          p.classList.toggle('relative', isActive);
          p.classList.toggle('opacity-0', !isActive);
          p.classList.toggle('absolute', !isActive);
          p.classList.toggle('pointer-events-none', !isActive);
        });
      });
    });
  }

  initCodeTabs();
  document.addEventListener('astro:page-load', initCodeTabs);
</script>
