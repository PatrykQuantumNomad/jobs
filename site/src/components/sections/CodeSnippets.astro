---
import { Code } from "astro:components";

const THEME = "github-dark-default";

const snippets = [
  {
    title: "Platform Protocol",
    filename: "platforms/protocols.py",
    description:
      "Runtime-checkable Protocol defines the contract every platform adapter must implement.",
    lang: "python" as const,
    code: `@runtime_checkable
class BrowserPlatform(Protocol):
    """Contract for browser-automated job platforms."""

    platform_name: str

    def init(self, context: BrowserContext) -> None: ...
    def login(self) -> bool: ...
    def is_logged_in(self) -> bool: ...
    def search(self, query: SearchQuery) -> list[Job]: ...
    def get_job_details(self, job: Job) -> Job: ...
    def apply(self, job: Job, resume_path: Path | None = None) -> bool: ...`,
  },
  {
    title: "Decorator Registry",
    filename: "platforms/registry.py",
    description:
      "Fail-fast decorator validates protocol compliance at import time -- no silent runtime failures.",
    lang: "python" as const,
    code: `def register_platform(
    key: str, *, name: str | None = None,
    platform_type: str = "browser",
    capabilities: list[str] | None = None,
) -> Any:
    """Register and validate a platform adapter class."""

    def decorator(cls: type) -> type:
        from platforms.protocols import APIPlatform, BrowserPlatform

        protocol = BrowserPlatform if platform_type == "browser" else APIPlatform
        _validate_against_protocol(cls, protocol)

        _REGISTRY[key] = PlatformInfo(
            key=key, name=name or key.title(),
            platform_type=platform_type, cls=cls,
            capabilities=capabilities or [],
        )
        return cls

    return decorator`,
  },
  {
    title: "Scoring Engine",
    filename: "scorer.py",
    description:
      "Weighted multi-factor scoring rates each job 1-5 against the candidate profile.",
    lang: "python" as const,
    code: `class JobScorer:
    """Score jobs 1-5 against candidate profile."""

    def _compute(self, job: Job) -> tuple[int, ScoreBreakdown]:
        w = self.weights

        title_pts = self._title_score(job.title)
        tech_pts, tech_matched = self._tech_score_with_keywords(job)
        remote_pts = self._location_score(job.location)
        salary_pts = self._salary_score(job)

        raw = (
            title_pts * w.title_match / 2.0
            + tech_pts * w.tech_overlap / 2.0
            + remote_pts * w.remote
            + salary_pts * w.salary
        )

        total = 5 if raw >= 5 else 4 if raw >= 4 else 3 if raw >= 3 else 2 if raw >= 2 else 1

        return total, ScoreBreakdown(
            title_points=title_pts, tech_points=tech_pts,
            tech_matched=tech_matched, remote_points=remote_pts,
            salary_points=salary_pts, total=total,
        )`,
  },
];
---

<section id="code" class="py-20 bg-surface-900">
  <div class="max-w-6xl mx-auto px-4">
    <h2 class="font-display text-3xl font-bold text-white text-center">
      Under the Hood
    </h2>
    <p class="mt-3 text-surface-400 text-center max-w-2xl mx-auto">
      Real code from the project -- protocol-driven architecture with pluggable platforms
    </p>

    <div class="mt-12 space-y-8">
      {snippets.map((snippet) => (
        <div class="rounded-xl overflow-hidden border border-surface-700">
          <div class="bg-surface-800 px-6 py-4">
            <h3 class="font-display font-semibold text-white">
              {snippet.title}
            </h3>
            <p class="mt-1 text-sm text-surface-400">
              {snippet.description}
            </p>
            <span class="mt-2 inline-block text-xs text-surface-500 font-mono">
              {snippet.filename}
            </span>
          </div>
          <div class="overflow-x-auto">
            <Code code={snippet.code} lang={snippet.lang} theme={THEME} />
          </div>
        </div>
      ))}
    </div>
  </div>
</section>
