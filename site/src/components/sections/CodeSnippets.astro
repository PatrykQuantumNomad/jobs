---
import { Code } from "astro:components";

const THEME = "one-dark-pro";

const snippets = [
  {
    id: "protocol",
    tab: "Protocol",
    title: "Platform Protocol",
    filename: "platforms/protocols.py",
    description:
      "Runtime-checkable Protocol defines the contract every platform adapter must implement.",
    lang: "python" as const,
    code: `@runtime_checkable
class BrowserPlatform(Protocol):
    """Contract for browser-automated job platforms."""

    platform_name: str

    def init(self, context: BrowserContext) -> None: ...
    def login(self) -> bool: ...
    def is_logged_in(self) -> bool: ...
    def search(self, query: SearchQuery) -> list[Job]: ...
    def get_job_details(self, job: Job) -> Job: ...
    def apply(self, job: Job, resume_path: Path | None = None) -> bool: ...`,
  },
  {
    id: "registry",
    tab: "Registry",
    title: "Decorator Registry",
    filename: "platforms/registry.py",
    description:
      "Fail-fast decorator validates protocol compliance at import time -- no silent runtime failures.",
    lang: "python" as const,
    code: `def register_platform(
    key: str, *, name: str | None = None,
    platform_type: str = "browser",
    capabilities: list[str] | None = None,
) -> Any:
    """Register and validate a platform adapter class."""

    def decorator(cls: type) -> type:
        from platforms.protocols import APIPlatform, BrowserPlatform

        protocol = BrowserPlatform if platform_type == "browser" else APIPlatform
        _validate_against_protocol(cls, protocol)

        _REGISTRY[key] = PlatformInfo(
            key=key, name=name or key.title(),
            platform_type=platform_type, cls=cls,
            capabilities=capabilities or [],
        )
        return cls

    return decorator`,
  },
  {
    id: "scoring",
    tab: "Scoring",
    title: "Scoring Engine",
    filename: "scorer.py",
    description:
      "Weighted multi-factor scoring rates each job 1-5 against the candidate profile.",
    lang: "python" as const,
    code: `class JobScorer:
    """Score jobs 1-5 against candidate profile."""

    def _compute(self, job: Job) -> tuple[int, ScoreBreakdown]:
        w = self.weights

        title_pts = self._title_score(job.title)
        tech_pts, tech_matched = self._tech_score_with_keywords(job)
        remote_pts = self._location_score(job.location)
        salary_pts = self._salary_score(job)

        raw = (
            title_pts * w.title_match / 2.0
            + tech_pts * w.tech_overlap / 2.0
            + remote_pts * w.remote
            + salary_pts * w.salary
        )

        total = 5 if raw >= 5 else 4 if raw >= 4 else 3 if raw >= 3 else 2 if raw >= 2 else 1

        return total, ScoreBreakdown(
            title_points=title_pts, tech_points=tech_pts,
            tech_matched=tech_matched, remote_points=remote_pts,
            salary_points=salary_pts, total=total,
        )`,
  },
];
---

<section id="code" data-animate class="py-20 bg-surface-900">
  <div class="max-w-4xl mx-auto px-4">
    <h2 class="font-display text-3xl font-bold text-white text-center">
      Under the Hood
    </h2>
    <p class="mt-3 text-surface-400 text-center max-w-2xl mx-auto">
      Real code from the project &mdash; protocol-driven architecture with pluggable platforms
    </p>

    <!-- Tab buttons -->
    <div class="mt-10 flex justify-center gap-2" id="code-tabs">
      {snippets.map((snippet, i) => (
        <button
          data-code-tab={snippet.id}
          class:list={[
            "px-4 py-2 rounded-lg text-sm font-semibold transition-all duration-200",
            i === 0
              ? "bg-primary-600 text-white shadow-md"
              : "text-surface-400 hover:text-white hover:bg-surface-800",
          ]}
        >
          {snippet.tab}
        </button>
      ))}
    </div>

    <!-- Tab panels -->
    <div class="mt-6 relative">
      {snippets.map((snippet, i) => (
        <div
          data-code-panel={snippet.id}
          class:list={[
            "rounded-xl overflow-hidden border border-surface-700/50",
            "shadow-[0_0_20px_oklch(0.52_0.175_155_/_0.08)]",
            "transition-opacity duration-300",
            i === 0 ? "opacity-100 relative" : "opacity-0 absolute inset-0 pointer-events-none",
          ]}
        >
          <div class="bg-surface-800/80 px-6 py-4 flex items-start justify-between">
            <div>
              <h3 class="font-display font-semibold text-white">
                {snippet.title}
              </h3>
              <p class="mt-1 text-sm text-surface-400">
                {snippet.description}
              </p>
            </div>
            <span class="shrink-0 ml-4 bg-accent-900/30 text-accent-300 font-mono text-xs px-2 py-1 rounded">
              {snippet.filename}
            </span>
          </div>
          <div class="overflow-x-auto">
            <Code code={snippet.code} lang={snippet.lang} theme={THEME} />
          </div>
        </div>
      ))}
    </div>
  </div>
</section>

<script>
  function initCodeTabs() {
    const container = document.getElementById('code-tabs');
    if (!container) return;

    const section = container.closest('section');
    if (!section) return;

    const buttons = section.querySelectorAll<HTMLElement>('[data-code-tab]');
    const panels = section.querySelectorAll<HTMLElement>('[data-code-panel]');

    buttons.forEach(btn => {
      btn.addEventListener('click', () => {
        const tab = btn.dataset.codeTab;

        buttons.forEach(b => {
          const isActive = b.dataset.codeTab === tab;
          b.classList.toggle('bg-primary-600', isActive);
          b.classList.toggle('text-white', isActive);
          b.classList.toggle('shadow-md', isActive);
          b.classList.toggle('text-surface-400', !isActive);
          b.classList.toggle('hover:text-white', !isActive);
          b.classList.toggle('hover:bg-surface-800', !isActive);
        });

        panels.forEach(p => {
          const isActive = p.dataset.codePanel === tab;
          p.classList.toggle('opacity-100', isActive);
          p.classList.toggle('relative', isActive);
          p.classList.toggle('opacity-0', !isActive);
          p.classList.toggle('absolute', !isActive);
          p.classList.toggle('pointer-events-none', !isActive);
        });
      });
    });
  }

  initCodeTabs();
  document.addEventListener('astro:page-load', initCodeTabs);
</script>
