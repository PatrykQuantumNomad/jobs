{% extends "base.html" %}
{% block title %}Kanban -- Job Tracker{% endblock %}

{% block content %}
<div class="mb-4 flex items-center justify-between">
    <h1 class="text-2xl font-bold text-gray-900">Kanban</h1>
    <a href="/" class="text-sm text-indigo-600 hover:text-indigo-800 font-medium">View all jobs in table</a>
</div>

<!-- Stats Cards -->
<div id="kanban-stats"
     hx-get="/api/stats-cards"
     hx-trigger="statsChanged from:body"
     hx-swap="innerHTML">
    {% include "partials/stats_cards.html" %}
</div>

{% set ns = namespace(total=0) %}
{% for s in kanban_statuses %}
    {% set ns.total = ns.total + columns[s] | length %}
{% endfor %}

{% if ns.total == 0 %}
<div class="text-center py-16 text-gray-400">
    <div class="text-lg font-medium">No jobs in the pipeline yet</div>
    <div class="text-sm mt-2">Import pipeline results or save jobs from the dashboard to see them here.</div>
</div>
{% else %}
<!-- Kanban Board -->
<div class="bg-gray-100 rounded-xl p-4 -mx-4">
    <div class="flex gap-3 overflow-x-auto pb-4">
        {% for status in kanban_statuses %}
        {% set is_terminal = status in terminal_statuses %}
        {% set colors = status_colors.get(status, {}) %}
        <div class="{% if is_terminal %}min-w-[220px] w-[220px] opacity-70{% else %}min-w-[260px] w-[260px]{% endif %} flex-shrink-0 flex flex-col">
            <!-- Column Header -->
            <div class="flex items-center gap-2 mb-3 px-1">
                <span class="w-2.5 h-2.5 rounded-full {{ colors.get('dot', 'bg-gray-400') }}"></span>
                <span class="text-sm font-semibold text-gray-700">
                    {{ status.replace('_', ' ').title() }}
                </span>
                <span class="col-count text-xs text-gray-500 font-medium bg-gray-200 rounded-full px-2 py-0.5">
                    {{ columns[status] | length }}
                </span>
            </div>
            <!-- Card List / Drop Zone -->
            <div class="kanban-list flex-1 space-y-2 min-h-[200px] bg-gray-50/50 rounded-lg p-2"
                 data-status="{{ status }}"
                 id="col-{{ status }}">
                {% for job in columns[status] %}
                    {% set card_status = status %}
                    {% include "partials/kanban_card.html" %}
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.6/Sortable.min.js"></script>
<script>
// Initialize SortableJS on each kanban column
document.querySelectorAll('.kanban-list').forEach(function(list) {
    new Sortable(list, {
        group: 'kanban',
        animation: 200,
        ghostClass: 'kanban-ghost',
        dragClass: 'kanban-drag',
        chosenClass: 'kanban-chosen',
        forceFallback: true,
        fallbackTolerance: 3,
        scrollSensitivity: 80,
        scrollSpeed: 12,
        onEnd: async function(evt) {
            var dedupKey = evt.item.dataset.key;
            var newStatus = evt.to.dataset.status;
            var oldStatus = evt.from.dataset.status;

            // If dropped in same column, do nothing
            if (newStatus === oldStatus) return;

            // Update the card's left border color to match new status
            var statusHexMap = {{ status_colors | tojson }};
            var newColor = statusHexMap[newStatus];
            if (newColor && newColor.hex) {
                evt.item.style.borderLeftColor = newColor.hex;
            }

            // Optimistically update column counts
            updateColumnCount(oldStatus, -1);
            updateColumnCount(newStatus, 1);

            try {
                var formData = new FormData();
                formData.append('status', newStatus);
                var response = await fetch('/jobs/' + encodeURIComponent(dedupKey) + '/status', {
                    method: 'POST',
                    body: formData
                });
                if (!response.ok) throw new Error('Status ' + response.status);
                // Trigger statsChanged so the stats cards partial refreshes
                document.body.dispatchEvent(new Event('statsChanged'));
            } catch (err) {
                // Rollback: move card back to original column at original index
                var fromCol = evt.from;
                var children = fromCol.children;
                if (evt.oldIndex >= children.length) {
                    fromCol.appendChild(evt.item);
                } else {
                    fromCol.insertBefore(evt.item, children[evt.oldIndex]);
                }
                // Rollback border color
                var oldColor = statusHexMap[oldStatus];
                if (oldColor && oldColor.hex) {
                    evt.item.style.borderLeftColor = oldColor.hex;
                }
                // Rollback counts
                updateColumnCount(oldStatus, 1);
                updateColumnCount(newStatus, -1);
                console.error('Failed to update job status:', err);
            }
        }
    });
});

function updateColumnCount(status, delta) {
    var col = document.getElementById('col-' + status);
    if (!col) return;
    var header = col.parentElement.querySelector('.col-count');
    if (!header) return;
    var match = header.textContent.match(/\d+/);
    var current = match ? parseInt(match[0], 10) : 0;
    var newCount = current + delta;
    header.textContent = newCount;
    // Pulse animation on count change
    header.classList.add('col-count-changed');
    setTimeout(function() { header.classList.remove('col-count-changed'); }, 400);
}
</script>
{% endblock %}
