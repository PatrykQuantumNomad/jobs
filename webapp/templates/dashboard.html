{% extends "base.html" %}
{% block title %}Dashboard â€” Job Tracker{% endblock %}

{% block content %}
<!-- Stats Bar -->
<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
    <div class="bg-white rounded-lg shadow-sm p-4 border">
        <div class="text-sm text-gray-500">Total Jobs</div>
        <div class="text-2xl font-bold">{{ stats.total }}</div>
    </div>
    <div class="bg-white rounded-lg shadow-sm p-4 border">
        <div class="text-sm text-gray-500">Score 5</div>
        <div class="text-2xl font-bold score-5">{{ stats.by_score.get(5, 0) }}</div>
    </div>
    <div class="bg-white rounded-lg shadow-sm p-4 border">
        <div class="text-sm text-gray-500">Score 4</div>
        <div class="text-2xl font-bold score-4">{{ stats.by_score.get(4, 0) }}</div>
    </div>
    <div class="bg-white rounded-lg shadow-sm p-4 border">
        <div class="text-sm text-gray-500">Applied</div>
        <div class="text-2xl font-bold text-purple-600">{{ stats.by_status.get('applied', 0) }}</div>
    </div>
</div>

<!-- Filters -->
<div class="bg-white rounded-lg shadow-sm border p-4 mb-6">
    <form method="get" action="/" class="flex flex-wrap items-center gap-4">
        <div class="w-full mb-3">
            <label class="text-xs text-gray-500 block mb-1">Search</label>
            <input type="search" name="q" placeholder="Search jobs by title, company, or description..."
                   value="{{ filters.q or '' }}"
                   hx-get="/search"
                   hx-trigger="input changed delay:500ms, keyup[key=='Enter']"
                   hx-target="#job-table-body"
                   hx-swap="innerHTML"
                   hx-include="[name='score'],[name='platform'],[name='status'],[name='sort'],[name='dir']"
                   class="border rounded px-3 py-1.5 text-sm w-full">
        </div>
        <div>
            <label class="text-xs text-gray-500 block mb-1">Min Score</label>
            <select name="score" class="border rounded px-3 py-1.5 text-sm">
                <option value="">All</option>
                {% for s in [5, 4, 3, 2, 1] %}
                <option value="{{ s }}" {% if filters.score == s %}selected{% endif %}>{{ s }}+</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label class="text-xs text-gray-500 block mb-1">Platform</label>
            <select name="platform" class="border rounded px-3 py-1.5 text-sm">
                <option value="">All</option>
                {% for p in stats.by_platform.keys() %}
                <option value="{{ p }}" {% if filters.platform == p %}selected{% endif %}>{{ p }}</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label class="text-xs text-gray-500 block mb-1">Status</label>
            <select name="status" class="border rounded px-3 py-1.5 text-sm">
                <option value="">All</option>
                {% for s in statuses %}
                <option value="{{ s }}" {% if filters.status == s %}selected{% endif %}>{{ s }}</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label class="text-xs text-gray-500 block mb-1">Sort</label>
            <select name="sort" class="border rounded px-3 py-1.5 text-sm">
                {% for opt in [("score", "Score"), ("company", "Company"), ("title", "Title"), ("created_at", "Date Added"), ("salary_min", "Salary")] %}
                <option value="{{ opt[0] }}" {% if filters.sort == opt[0] %}selected{% endif %}>{{ opt[1] }}</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label class="text-xs text-gray-500 block mb-1">Direction</label>
            <select name="dir" class="border rounded px-3 py-1.5 text-sm">
                <option value="desc" {% if filters.dir == 'desc' %}selected{% endif %}>Desc</option>
                <option value="asc" {% if filters.dir == 'asc' %}selected{% endif %}>Asc</option>
            </select>
        </div>
        <div class="self-end">
            <button type="submit" class="bg-gray-800 text-white px-4 py-1.5 rounded text-sm font-medium hover:bg-gray-900">
                Filter
            </button>
        </div>
        <div class="self-end">
            <a href="/" class="text-sm text-gray-500 hover:text-gray-700 underline">Reset</a>
        </div>
    </form>
</div>

<!-- Bulk Action Bar -->
<div id="bulk-bar" class="hidden bg-indigo-50 border border-indigo-200 rounded-lg p-3 mb-4 flex items-center gap-4">
    <span id="selected-count" class="text-sm font-medium text-indigo-800">0 selected</span>
    <select name="bulk_status" class="border rounded px-3 py-1.5 text-sm">
        <option value="">Change status to...</option>
        {% for s in statuses %}
        <option value="{{ s }}">{{ s | replace('_', ' ') | title }}</option>
        {% endfor %}
    </select>
    <button type="button"
            hx-post="/bulk/status"
            hx-include="#bulk-form, [name='q'], [name='score'], [name='platform'], [name='status'], [name='sort'], [name='dir']"
            hx-target="#job-table-body"
            hx-swap="innerHTML"
            class="bg-indigo-600 text-white px-4 py-1.5 rounded text-sm font-medium hover:bg-indigo-700">
        Apply
    </button>
    <button type="button" onclick="clearSelection()" class="text-sm text-gray-500 hover:text-gray-700">
        Clear
    </button>
</div>

<!-- Job Table -->
<form id="bulk-form">
<div class="bg-white rounded-lg shadow-sm border overflow-hidden">
    <table class="w-full text-sm">
        <thead class="bg-gray-50 border-b">
            <tr>
                <th class="px-4 py-3 w-10">
                    <input type="checkbox" id="select-all" class="rounded border-gray-300"
                           onchange="toggleSelectAll(this)">
                </th>
                <th class="px-4 py-3 text-left font-medium text-gray-600">Score</th>
                <th class="px-4 py-3 text-left font-medium text-gray-600">Company</th>
                <th class="px-4 py-3 text-left font-medium text-gray-600">Title</th>
                <th class="px-4 py-3 text-left font-medium text-gray-600 hidden md:table-cell">Location</th>
                <th class="px-4 py-3 text-left font-medium text-gray-600 hidden lg:table-cell">Salary</th>
                <th class="px-4 py-3 text-left font-medium text-gray-600">Platform</th>
                <th class="px-4 py-3 text-left font-medium text-gray-600">Status</th>
            </tr>
        </thead>
        <tbody id="job-table-body" class="divide-y">
            {% include "partials/job_rows.html" %}
        </tbody>
    </table>
</div>
</form>

<div class="mt-4 flex items-center justify-between">
    <div class="text-sm text-gray-400">{{ jobs | length }} jobs displayed</div>
    <div class="flex gap-2">
        <a id="export-csv-link"
           href="/export/csv?q={{ filters.q or '' | urlencode }}&score={{ filters.score or '' }}&platform={{ filters.platform or '' }}&status={{ filters.status or '' }}&sort={{ filters.sort or 'score' }}&dir={{ filters.dir or 'desc' }}"
           class="text-sm px-3 py-1.5 rounded border text-gray-600 hover:bg-gray-50">
            Export CSV
        </a>
        <a id="export-json-link"
           href="/export/json?q={{ filters.q or '' | urlencode }}&score={{ filters.score or '' }}&platform={{ filters.platform or '' }}&status={{ filters.status or '' }}&sort={{ filters.sort or 'score' }}&dir={{ filters.dir or 'desc' }}"
           class="text-sm px-3 py-1.5 rounded border text-gray-600 hover:bg-gray-50">
            Export JSON
        </a>
    </div>
</div>

<script>
function toggleSelectAll(el) {
    document.querySelectorAll('input[name="job_keys"]').forEach(cb => {
        cb.checked = el.checked;
    });
    updateBulkBar();
}

function updateBulkBar() {
    const count = document.querySelectorAll('input[name="job_keys"]:checked').length;
    document.getElementById('selected-count').textContent = count + ' selected';
    document.getElementById('bulk-bar').classList.toggle('hidden', count === 0);
}

function clearSelection() {
    document.querySelectorAll('input[name="job_keys"]').forEach(cb => cb.checked = false);
    document.getElementById('select-all').checked = false;
    updateBulkBar();
}

// Re-attach after htmx swaps (checkboxes are replaced)
document.body.addEventListener('htmx:afterSwap', function(e) {
    if (e.detail.target.id === 'job-table-body') {
        document.getElementById('select-all').checked = false;
        updateBulkBar();
    }
});
</script>
{% endblock %}
